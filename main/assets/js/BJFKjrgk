üßÆ Step 2 ‚Äî Generate the 10 aspects automatically via JS

Add this block near the top of your script (after DOM loads or inside window.onload):

parakletosschool2004@gmail.com
  Admin-123456789

// ---------------------------
// Generate Rating Table Rows
// ---------------------------
const ratingAspects = [
  "Neatness",
  "Politeness",
  "Punctuality",
  "Attentiveness",
  "Responsibility",
  "Teamwork",
  "Leadership",
  "Self-Control",
  "Honesty",
  "Participation"
];

const ratingTableBody = document.getElementById("ratingTable");
ratingAspects.forEach((aspect) => {
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td>${aspect}</td>
    ${[5,4,3,2,1].map(val =>
      `<td><input type="checkbox" name="${aspect}" value="${val}" class="ratingBox"></td>`
    ).join("")}
  `;
  ratingTableBody.appendChild(tr);
});

// ensure only one tick per row
ratingTableBody.addEventListener("change", (e) => {
  if (e.target.classList.contains("ratingBox")) {
    const name = e.target.name;
    document.querySelectorAll(`input[name="${name}"]`).forEach(box => {
      if (box !== e.target) box.checked = false;
    });
  }
});

üíæ Step 3 ‚Äî Extend your ‚ÄúSave Result‚Äù logic

Find this block:

const resultData = {
  studentID,
  term,
  classTeacherRemark,
  headTeacherRemark,
  workEdu,
  artEdu,
  healthEdu,
  dateIssued: new Date().toLocaleDateString(),
  subjects
};


Replace it with:

// Collect attendance & health
const daysOpened = document.getElementById("daysOpened").value.trim();
const daysPresent = document.getElementById("daysPresent").value.trim();
const daysAbsent = document.getElementById("daysAbsent").value.trim();
const studentHeight = document.getElementById("studentHeight").value.trim();
const studentWeight = document.getElementById("studentWeight").value.trim();
const nextTermDate = document.getElementById("nextTermDate").value;

// Collect ratings
const ratings = {};
ratingAspects.forEach(aspect => {
  const checked = document.querySelector(`input[name="${aspect}"]:checked`);
  ratings[aspect] = checked ? checked.value : "";
});

const resultData = {
  studentID,
  term,
  classTeacherRemark,
  headTeacherRemark,
  workEdu,
  artEdu,
  healthEdu,
  daysOpened,
  daysPresent,
  daysAbsent,
  studentHeight,
  studentWeight,
  nextTermDate,
  ratings,
  dateIssued: new Date().toLocaleDateString(),
  subjects
};


This ensures the new inputs + rating table are saved into Firebase.

üì• Step 4 ‚Äî Extend the ‚ÄúLoad Previous Results‚Äù section

Right after this line inside your if (snapshot.exists()) { ... } block:

document.getElementById("headTeacherRemark").value = data.headTeacherRemark || "";


add:

// Load attendance & health
document.getElementById("daysOpened").value = data.daysOpened || "";
document.getElementById("daysPresent").value = data.daysPresent || "";
document.getElementById("daysAbsent").value = data.daysAbsent || "";
document.getElementById("studentHeight").value = data.studentHeight || "";
document.getElementById("studentWeight").value = data.studentWeight || "";
document.getElementById("nextTermDate").value = data.nextTermDate || "";

// Load ratings
if (data.ratings) {
  Object.keys(data.ratings).forEach(aspect => {
    const val = data.ratings[aspect];
    if (val) {
      const box = document.querySelector(`input[name="${aspect}"][value="${val}"]`);
      if (box) box.checked = true;
    }
  });
}

üñ® Step 5 ‚Äî (Optional) Include these in the Print view

If you want the new data to appear on the printed result, I can modify that section next ‚Äî would you like me to include those fields (attendance, health, next term, and ratings) in the print layout too?




// result-add.js
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";
import { saveResult } from "./result-save.js";

// ---------------------------
// Firebase Configs
// ---------------------------
const studentFirebaseConfig = {
  apiKey: "AIzaSyCz8GoyOi7wviejSPG2CGkOYvEwsaAWX0w",
  authDomain: "damotak-students-database.firebaseapp.com",
  databaseURL: "https://damotak-students-database-default-rtdb.firebaseio.com/",
  projectId: "damotak-students-database",
  storageBucket: "damotak-students-database.firebasestorage.app",
  messagingSenderId: "806502646085",
  appId: "1:806502646085:web:36a97f1d1e0ff4bab6be2c"
};

const resultFirebaseConfig = {
  apiKey: "AIzaSyDcrh8wVfeVwnOKnt-AcWDMOmxqNWe_0Uw",
  authDomain: "damotak-result-database.firebaseapp.com",
  databaseURL: "https://damotak-result-database-default-rtdb.firebaseio.com/",
  projectId: "damotak-result-database",
  storageBucket: "damotak-result-database.firebasestorage.app",
  messagingSenderId: "413754960869",
  appId: "1:413754960869:web:b3f51b6aaa0c667af0dd0c"
};

// ---------------------------
// Initialize Firebase Apps
// ---------------------------
const studentApp = initializeApp(studentFirebaseConfig, "studentDB");
const studentDb = getDatabase(studentApp);

const resultApp = initializeApp(resultFirebaseConfig, "resultDB");
const resultDb = getDatabase(resultApp);

<thead>
        <tr>
          <th>SL.</th>
          <th>SUBJECT</th>
          
          <th>C.A</th>
         
          <th>EXAM</th>
          <th>TOTAL (100)</th>
          <th>GRADE</th>
          <th>REMARK</th>
          
        </tr>
      </thead>


yes If you want, I can rewrite your entire loadPreviousResults() + helper functions fully integrated with Yearly Summary, average calculation, and auto promotion so you can just drop it into your result-add.js without breaking anything. here is my html code [ <!-- meta tags and other links -->
<!DOCTYPE html>
<html lang="en" data-theme="light">

<thead>
        <tr>
          <th>SL.</th>
          <th>SUBJECT</th>
          <th>TOTAL C.A</th>
          <th>TOTAL EXAM</th>
          <th>TOTAL (100)</th>
          <th>GRADE</th>
          <th>REMARK</th>
         
        </tr>
      </thead>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ADMIN PAGE</title>
  <link rel="icon" type="image/png" href="assets/images/auth/Damotak Logo.png">
  <!-- remix icon font css  -->
  <link rel="stylesheet" href="assets/css/remixicon.css">
  <!-- BootStrap css -->
  <link rel="stylesheet" href="assets/css/lib/bootstrap.min.css">
  <!-- Apex Chart css -->
  <link rel="stylesheet" href="assets/css/lib/apexcharts.css">
  <!-- Data Table css -->
  <link rel="stylesheet" href="assets/css/lib/dataTables.min.css">
  <!-- Text Editor css -->
  <link rel="stylesheet" href="assets/css/lib/editor-katex.min.css">
  <link rel="stylesheet" href="assets/css/lib/editor.atom-one-dark.min.css">
  <link rel="stylesheet" href="assets/css/lib/editor.quill.snow.css">
  <!-- Date picker css -->
  <link rel="stylesheet" href="assets/css/lib/flatpickr.min.css">
  <!-- Calendar css -->
  <link rel="stylesheet" href="assets/css/lib/full-calendar.css">
  <!-- Vector Map css -->
  <link rel="stylesheet" href="assets/css/lib/jquery-jvectormap-2.0.5.css">
  <!-- Popup css -->
  <link rel="stylesheet" href="assets/css/lib/magnific-popup.css">
  <!-- Slick Slider css -->
  <link rel="stylesheet" href="assets/css/lib/slick.css">
  <!-- prism css -->
  <link rel="stylesheet" href="assets/css/lib/prism.css">
  <!-- file upload css -->
  <link rel="stylesheet" href="assets/css/lib/file-upload.css">

  <link rel="stylesheet" href="assets/css/lib/audioplayer.css">
  <!-- main css -->
  <link rel="stylesheet" href="assets/css/style.css">
</head>

<body>

  <!-- Theme Customization Structure Start -->
<div class="body-overlay"></div>

<button type="button"
    class="theme-customization__button w-48-px h-48-px bg-primary-600 text-white rounded-circle d-flex justify-content-center align-items-center position-fixed end-0 bottom-0 mb-40 me-40 text-2xxl bg-hover-primary-700">
    <i class="ri-settings-3-line animate-spin"></i>
</button>
<div class="theme-customization-sidebar w-100 bg-base h-100vh overflow-y-auto position-fixed end-0 top-0 shadow-lg">
    <div class="d-flex align-items-center gap-3 py-16 px-24 justify-content-between border-bottom">
        <div>
            <h6 class="text-sm dark:text-white">Theme Settings</h6>
            <p class="text-xs mb-0 text-neutral-500 dark:text-neutral-200">Customize and preview instantly</p>
        </div>
        <button data-slot="button"
            class="theme-customization-sidebar__close text-neutral-900 bg-transparent text-hover-primary-600 d-flex text-xl">
            <i class="ri-close-fill"></i>
        </button>
    </div>

    <div class="d-flex flex-column gap-48 p-24 overflow-y-auto flex-grow-1">

        <div class="theme-setting-item">
            <h6 class="fw-medium text-primary-light text-md mb-3">Theme Mode</h6>
            <div class="d-grid grid-cols-3 gap-3 dark-light-mode">
                <button type="button"
                    class="theme-btn theme-setting-item__btn d-flex align-items-center justify-content-center h-64-px rounded-3 text-xl active"
                    data-theme="light">
                    <i class="ri-sun-line"></i>
                </button>
                <button type="button"
                    class="theme-btn theme-setting-item__btn d-flex align-items-center justify-content-center h-64-px rounded-3 text-xl"
                    data-theme="dark">
                    <i class="ri-moon-line"></i>
                </button>
                <button type="button"
                    class="theme-btn theme-setting-item__btn d-flex align-items-center justify-content-center h-64-px rounded-3 text-xl"
                    data-theme="system">
                    <i class="ri-computer-line"></i>
                </button>
            </div>
        </div>

        document.getElementById("studentTerm").addEventListener("change", async (e) => {
          const term = e.target.value;
          if (term === "Yearly Summary") {
            await loadYearlySummary();
          } else {
            await loadPreviousResults();
          }
        });
        
        async function loadYearlySummary() {
          tbody.innerHTML = ""; // Clear table first
        
          const terms = ["First Term", "Second Term", "Third Term"];
          const termResults = {};
        
          for (let t of terms) {
            const snapshot = await get(ref(resultDb, `Results/${studentID}/${t}`));
            termResults[t] = snapshot.exists() ? snapshot.val().Subjects : {};
          }
        
          // Get all subjects across 3 terms
          const allSubjects = new Set();
          terms.forEach(t => Object.keys(termResults[t] || {}).forEach(sub => allSubjects.add(sub)));
        
          allSubjects.forEach((subject, index) => {
            const firstTerm = termResults["First Term"][subject] || { ca: 0, exam: 0, total: 0 };
            const secondTerm = termResults["Second Term"][subject] || { ca: 0, exam: 0, total: 0 };
            const thirdTerm = termResults["Third Term"][subject] || { ca: 0, exam: 0, total: 0 };
        
            const avgTotal = ((firstTerm.total + secondTerm.total + thirdTerm.total) / 3).toFixed(2);
        
            let grade = "-", remark = "-";
            if (avgTotal >= 70) { grade = "A"; remark = "Excellent"; }
            else if (avgTotal >= 60) { grade = "B"; remark = "Very Good"; }
            else if (avgTotal >= 50) { grade = "C"; remark = "Good"; }
            else if (avgTotal >= 40) { grade = "D"; remark = "Fair"; }
            else { grade = "F"; remark = "Fail"; }
        
            // Add row
            const row = document.createElement("tr");
            row.innerHTML = `
              <td class="sl">${index + 1}</td>
              <td>${subject}</td>
              <td>30</td>
              <td>${firstTerm.ca || 0}</td>
              <td>70</td>
              <td>${firstTerm.exam || 0}</td>
              <td>${firstTerm.total || 0}</td>
              <td>${firstTerm.total || 0}</td>
              <td>${firstTerm.total || 0}</td>
              <td>${secondTerm.total || 0}</td>
              <td>${thirdTerm.total || 0}</td>
              <td>${avgTotal}</td>
              <td>${grade}</td>
              <td>${remark}</td>
            `;
            tbody.appendChild(row);
          });
        
          // Update table header for yearly summary
          document.querySelector("#resultTable thead").innerHTML = `
            <tr>
              <th>SL.</th>
              <th>SUBJECT</th>
              <th>MARK OBTAINABLE (CA)</th>
              <th>C.A</th>
              <th>MARK OBTAINABLE (EXAM)</th>
              <th>EXAM</th>
              <th>TOTAL (100)</th>
              <th>FIRST TERM SCORE</th>
              <th>SECOND TERM SCORE</th>
              <th>THIRD TERM SCORE</th>
              <th>AVARAGE TOTAL (100)</th>
              <th>GRADE</th>
              <th>REMARK</th>
            </tr>
          `;
        
          // Add Promotion Status
          addPromotionStatus();
        }
        
        function addPromotionStatus() {
          // Remove existing textarea if present
          const existing = document.getElementById("promotionStatus");
          if (existing) existing.remove();
        
          // Calculate pass/fail based on grades
          let allRows = Array.from(tbody.querySelectorAll("tr"));
          let pass = allRows.every(row => {
            const remark = row.querySelector("td:last-child").textContent.trim();
            return remark !== "Fail";
          });
        
          const promotionDiv = document.createElement("div");
          promotionDiv.classList.add("p-3", "mt-4", "border-top");
          promotionDiv.innerHTML = `
            <label>Promotion Status:</label>
            <textarea id="promotionStatus" class="form-control" rows="2" readonly>${pass ? "Promoted ‚úÖ" : "Failed ‚ùå"}</textarea>
          `;
          tbody.parentElement.appendChild(promotionDiv);
        }

        <thead>
        <tr>
          <th>SL.</th>
          <th>SUBJECT</th>
          <th>FIRST TERM SCORE</th>
          <th>SECOND TERM SCORE</th>
          <th>THIRD TERM SCORE</th>
          <th>AVARAGE TOTAL (100)</th>
          <th>GRADE</th>
          <th>REMARK</th>
          
        </tr>
      </thead>

        <div class="theme-setting-item">
            <h6 class="fw-medium text-primary-light text-md mb-3">Page Direction</h6>
            <div class="d-grid grid-cols-2 gap-3">
                <button type="button"
                    class="theme-setting-item__btn ltr-mode-btn d-flex align-items-center justify-content-center gap-2 h-56-px rounded-3 text-xl">
                    <span><i class="ri-align-item-left-line"></i></span>
                    <span class="h6 text-sm font-medium mb-0">LTR</span>
                </button>

                <button type="button"
                    class="theme-setting-item__btn rtl-mode-btn d-flex align-items-center justify-content-center gap-2 h-56-px rounded-3 text-xl">
                    <span class="h6 text-sm font-medium mb-0">RTL</span>
                    <span><i class="ri-align-item-right-line"></i></span>
                </button>
            </div>
        </div>

        <div class="theme-setting-item">
            <h6 class="fw-medium text-primary-light text-md mb-3">Color Schema</h6>
            <div class="d-grid grid-cols-3 gap-3">
                <button type="button"
                    class="color-picker-btn d-flex flex-column justify-content-center align-items-center"
                    data-color="blue">
                    <span class="color-picker-btn__box h-40-px w-100 rounded-3"
                        style="background-color: #2563eb;"></span>
                    <span class="fw-medium mt-1" style="color: #2563eb;">Blue</span>
                </button>
                <button type="button"
                    class="color-picker-btn d-flex flex-column justify-content-center align-items-center"
                    data-color="red">
                    <span class="color-picker-btn__box h-40-px w-100 rounded-3"
                        style="background-color: #dc2626;"></span>
                    <span class="fw-medium mt-1" style="color: #dc2626;">Red</span>
                </button>
                <button type="button"
                    class="color-picker-btn d-flex flex-column justify-content-center align-items-center"
                    data-color="green">
                    <span class="color-picker-btn__box h-40-px w-100 rounded-3"
                        style="background-color: #16a34a;"></span>
                    <span class="fw-medium mt-1" style="color: #16a34a;">Green</span>
                </button>
                <button type="button"
                    class="color-picker-btn d-flex flex-column justify-content-center align-items-center"
                    data-color="yellow">
                    <span class="color-picker-btn__box h-40-px w-100 rounded-3"
                        style="background-color: #ff9f29;"></span>
                    <span class="fw-medium mt-1" style="color: #ff9f29;">Yellow</span>
                </button>
                <button type="button"
                    class="color-picker-btn d-flex flex-column justify-content-center align-items-center"
                    data-color="cyan">
                    <span class="color-picker-btn__box h-40-px w-100 rounded-3"
                        style="background-color: #00b8f2;"></span>
                    <span class="fw-medium mt-1" style="color: #00b8f2;">Cyan</span>
                </button>
                <button type="button"
                    class="color-picker-btn d-flex flex-column justify-content-center align-items-center"
                    data-color="violet">
                    <span class="color-picker-btn__box h-40-px w-100 rounded-3"
                        style="background-color: #7c3aed;"></span>
                    <span class="fw-medium mt-1" style="color: #7c3aed;">Violet</span>
                </button>
            </div>
        </div>

    </div>
</div>
<!-- Theme Customization Structure End -->
<!--- Navbar Section Start-->
<aside class="sidebar">
  <button type="button" class="sidebar-close-btn">
    <iconify-icon icon="radix-icons:cross-2"></iconify-icon>
  </button>
  <div>
    <a href="admin-dashboard.html" class="sidebar-logo">
     <img src="assets/images/auth/Damotak Logo.png" alt="site logo" class="light-logo">
      <img src="assets/images/auth/Damotak Logo.png" alt="site logo" class="dark-logo">
      <img src="assets/images/auth/Damotak Logo.png" alt="site logo" class="logo-icon">
    </a>
  </div>
  <div class="sidebar-menu-area">
    <ul class="sidebar-menu" id="sidebar-menu">
      <li class="dropdown">
        <a href="javascript:void(0)">
          <iconify-icon icon="solar:home-smile-angle-outline" class="menu-icon"></iconify-icon>
          <span>Dashboard</span>
        </a>
        <ul class="sidebar-submenu">
         
          <li>
            <a href="admin-dashboard.html"><i class="ri-circle-fill circle-icon text-warning-main w-auto"></i> Home</a>
          </li>
        </ul>
      </li>

      <li class="sidebar-menu-group-title">Students Application </li>

     
      
      <li>
        <a href="classes.html">
          <iconify-icon icon="solar:calendar-outline" class="menu-icon"></iconify-icon>
          <span>Classes</span>
        </a>
      </li>

      <li class="dropdown">
        <a href="javascript:void(0)">
          <iconify-icon icon="flowbite:users-group-outline" class="menu-icon"></iconify-icon>
          <span>Students</span>
        </a>
        <ul class="sidebar-submenu">
          <li>
            <a href="student-list.html"><i class="ri-circle-fill circle-icon text-primary-600 w-auto"></i> Students List</a>
          </li>
          
          <li>
            <a href="student-add.html"><i class="ri-circle-fill circle-icon text-info-main w-auto"></i> Add Students</a>
          </li>
        </ul>
      </li>
     
      <li class="dropdown">
        <a href="javascript:void(0)">
          <iconify-icon icon="hugeicons:invoice-03" class="menu-icon"></iconify-icon>
          <span>Result</span>
        </a>
        <ul class="sidebar-submenu">
          <li>
            <a href="result-list.html"><i class="ri-circle-fill circle-icon text-primary-600 w-auto"></i> List</a>
          </li>
          <li>
            <a href="result-add.html"><i class="ri-circle-fill circle-icon text-warning-main w-auto"></i>
              Add New</a>
          </li>
          <li>
            <a href="result-edit.html"><i class="ri-circle-fill circle-icon text-info-main w-auto"></i> Edit</a>
          </li>
          <li>
            <a href="result preview.html"><i class="ri-circle-fill circle-icon text-danger-main w-auto"></i> Preview</a>
          </li>
        </ul>
      </li>
      
      <li class="sidebar-menu-group-title">Staff Application</li>

      <li class="dropdown">
        <a href="javascript:void(0)">
          <i class="ri-user-settings-line text-xl me-14 d-flex w-auto"></i>
          <span>Staff Role</span>
        </a>
        <ul class="sidebar-submenu">
          <li>
            <a href="staff-role.html"><i class="ri-circle-fill circle-icon text-primary-600 w-auto"></i> Staff Role</a>
          </li>
          
        </ul>
      </li>

      <li class="sidebar-menu-group-title">Other Assessments</li>

      
      <li class="dropdown">
        <a href="javascript:void(0)">
          <iconify-icon icon="icon-park-outline:setting-two" class="menu-icon"></iconify-icon>
          <span>Settings</span>
        </a>
        <ul class="sidebar-submenu">
          <li>
            <a href="view-profile.html"><i class="ri-circle-fill circle-icon text-primary-600 w-auto"></i> School Profile</a>
          </li>
         
        </ul>
      </li>
    </ul>
  </div>
</aside>
<!-- Navbar Sections Ends -->

<main class="dashboard-main">
  <div class="navbar-header">
  <div class="row align-items-center justify-content-between">
    <div class="col-auto">
      <div class="d-flex flex-wrap align-items-center gap-4">
        <button type="button" class="sidebar-toggle">
          <iconify-icon icon="heroicons:bars-3-solid" class="icon text-2xl non-active"></iconify-icon>
          <iconify-icon icon="iconoir:arrow-right" class="icon text-2xl active"></iconify-icon>
        </button>
        <button type="button" class="sidebar-mobile-toggle">
          <iconify-icon icon="heroicons:bars-3-solid" class="icon"></iconify-icon>
        </button>
        <form class="navbar-search">
          <input type="text" name="search" placeholder="Search">
          <iconify-icon icon="ion:search-outline" class="icon"></iconify-icon>
        </form>
      </div>
    </div>
    <div class="col-auto">
      <div class="d-flex flex-wrap align-items-center gap-3">
        <button type="button" data-theme-toggle
          class="w-40-px h-40-px bg-neutral-200 rounded-circle d-flex justify-content-center align-items-center"></button>
        <div class="dropdown d-none d-sm-inline-block">
          <button
            class="has-indicator w-40-px h-40-px bg-neutral-200 rounded-circle d-flex justify-content-center align-items-center"
            type="button" data-bs-toggle="dropdown">
            <img src="assets/images/lang-flag.png" alt="image" class="w-24 h-24 object-fit-cover rounded-circle">
          </button>
          <div class="dropdown-menu to-top dropdown-menu-sm">
            <div
              class="py-12 px-16 radius-8 bg-primary-50 mb-16 d-flex align-items-center justify-content-between gap-2">
              <div>
                <h6 class="text-lg text-primary-light fw-semibold mb-0">Choose Your Language</h6>
              </div>
            </div>

            <div class="max-h-400-px overflow-y-auto scroll-sm pe-8">
              <div class="form-check style-check d-flex align-items-center justify-content-between mb-16">
                <label class="form-check-label line-height-1 fw-medium text-secondary-light" for="english">
                  <span class="text-black hover-bg-transparent hover-text-primary d-flex align-items-center gap-3">
                    <img src="assets/images/flags/flag1.png" alt=""
                      class="w-36-px h-36-px bg-success-subtle text-success-main rounded-circle flex-shrink-0">
                    <span class="text-md fw-semibold mb-0">English</span>
                  </span>
                </label>
                <input class="form-check-input" type="radio" name="crypto" id="english">
              </div>

            </div>
          </div>
        </div><!-- Language dropdown end -->

        <div class="dropdown">
          <button
            class="has-indicator w-40-px h-40-px bg-neutral-200 rounded-circle d-flex justify-content-center align-items-center"
            type="button" data-bs-toggle="dropdown">
            <iconify-icon icon="mage:email" class="text-primary-light text-xl"></iconify-icon>
          </button>
          <div class="dropdown-menu to-top dropdown-menu-lg p-0">
            <div
              class="m-16 py-12 px-16 radius-8 bg-primary-50 mb-16 d-flex align-items-center justify-content-between gap-2">
              <div>
                <h6 class="text-lg text-primary-light fw-semibold mb-0">Message</h6>
              </div>
              <span
                class="text-primary-600 fw-semibold text-lg w-40-px h-40-px rounded-circle bg-base d-flex justify-content-center align-items-center">0</span>
            </div>

            <div class="max-h-400-px overflow-y-auto scroll-sm pe-4">

            </div>
            <div class="text-center py-12 px-16">
              <a href="javascript:void(0)" class="text-primary-600 fw-semibold text-md">See All Message</a>
            </div>
          </div>
        </div><!-- Message dropdown end -->

        <div class="dropdown">
          <button
            class="has-indicator w-40-px h-40-px bg-neutral-200 rounded-circle d-flex justify-content-center align-items-center"
            type="button" data-bs-toggle="dropdown">
            <iconify-icon icon="iconoir:bell" class="text-primary-light text-xl"></iconify-icon>
          </button>
          <div class="dropdown-menu to-top dropdown-menu-lg p-0">
            <div
              class="m-16 py-12 px-16 radius-8 bg-primary-50 mb-16 d-flex align-items-center justify-content-between gap-2">
              <div>
                <h6 class="text-lg text-primary-light fw-semibold mb-0">Notifications</h6>
              </div>
              <span
                class="text-primary-600 fw-semibold text-lg w-40-px h-40-px rounded-circle bg-base d-flex justify-content-center align-items-center">01</span>
            </div>

            <div class="max-h-400-px overflow-y-auto scroll-sm pe-4">
              <a href="javascript:void(0)"
                class="px-24 py-12 d-flex align-items-start gap-3 mb-2 justify-content-between">
                <div class="text-black hover-bg-transparent hover-text-primary d-flex align-items-center gap-3">
                  <span
                    class="w-44-px h-44-px bg-success-subtle text-success-main rounded-circle d-flex justify-content-center align-items-center flex-shrink-0">
                    <iconify-icon icon="bitcoin-icons:verify-outline" class="icon text-xxl"></iconify-icon>
                  </span>
                  <div>
                    <h6 class="text-md fw-semibold mb-4">Congratulations</h6>
                    <p class="mb-0 text-sm text-secondary-light text-w-200-px">Admin Login Successfully</p>
                  </div>
                </div>
                <span class="text-sm text-secondary-light flex-shrink-0">23 Mins ago</span>
              </a>

            </div>

            <div class="text-center py-12 px-16">
              <a href="javascript:void(0)" class="text-primary-600 fw-semibold text-md">See All Notification</a>
            </div>

          </div>
        </div><!-- Notification dropdown end -->

        <div class="dropdown">
          <button class="d-flex justify-content-center align-items-center rounded-circle" type="button"
            data-bs-toggle="dropdown">
            <img src="assets/images/user.png" alt="image" class="w-40-px h-40-px object-fit-cover rounded-circle">
          </button>
          <div class="dropdown-menu to-top dropdown-menu-sm">
            <div
              class="py-12 px-16 radius-8 bg-primary-50 mb-16 d-flex align-items-center justify-content-between gap-2">
              <div>
                <h6 class="text-lg text-primary-light fw-semibold mb-2">DLS ADMIN</h6>
                <span class="text-secondary-light fw-medium text-sm">Admin</span>
              </div>
              <button type="button" class="hover-text-danger">
                <iconify-icon icon="radix-icons:cross-1" class="icon text-xl"></iconify-icon>
              </button>
            </div>
            <ul class="to-top-list">
              <li>
                <a class="dropdown-item text-black px-0 py-8 hover-bg-transparent hover-text-primary d-flex align-items-center gap-3"
                  href="view-profile.html">
                  <iconify-icon icon="solar:user-linear" class="icon text-xl"></iconify-icon> My Profile</a>
              </li>
              
              <li>
                <a class="dropdown-item text-black px-0 py-8 hover-bg-transparent hover-text-danger d-flex align-items-center gap-3"
                  href="" id="logoutBtn">
                  <iconify-icon icon="lucide:power" class="icon text-xl"></iconify-icon> Log Out</a>
              </li>
            </ul>
          </div>
        </div><!-- Profile dropdown end -->
      </div>
    </div>
  </div>
</div>

  <div class="dashboard-main-body">

    <div class="d-flex flex-wrap align-items-center justify-content-between gap-3 mb-24">
  <h6 class="fw-semibold mb-0">Add Students Result</h6>
  <ul class="d-flex align-items-center gap-2">
    <li class="fw-medium">
      <a href="admin-dashboard.html" class="d-flex align-items-center gap-1 hover-text-primary">
        <iconify-icon icon="solar:home-smile-angle-outline" class="icon text-lg"></iconify-icon>
        Dashboard
      </a>
    </li>
    <li>-</li>
    <li class="fw-medium">Add Students Result</li>
  </ul>
</div>
    
     <div class="card">
    <div class="card-header">
      <div class="d-flex flex-wrap align-items-center justify-content-end gap-2">
        <button id="backBtn" type="button" class="btn btn-sm btn-primary-600 radius-8 d-inline-flex align-items-center gap-1">
  <iconify-icon icon="simple-line-icons:arrow-left" class="text-xl"></iconify-icon>
  Back
</button>

        <button id="saveResult" type="button" class="btn btn-sm btn-warning radius-8 d-inline-flex align-items-center gap-1">
          <iconify-icon icon="simple-line-icons:check" class="text-xl"></iconify-icon>
          Save Result
        </button>
        

        <button id="PrintResult" type="button" class="btn btn-sm btn-primary-600 radius-8 d-inline-flex align-items-center gap-1">
  <iconify-icon icon="simple-line-icons:check" class="text-xl"></iconify-icon>
  Print Result
</button>

        
      </div>
    </div>

    <div class="card-body py-40">
      <div class="row justify-content-center" id="invoice">
        <div class="col-lg-8">
          <div class="shadow-4 border radius-8">

            <!-- School Header -->
            <div class="p-20 border-bottom text-center">
              <img src="assets/images/Damotak Logo.png" alt="image" width="90">
              <h3 class="text-xl mt-2">DAMOTAK INTERNATIONAL SCHOOL</h3>
              <p class="text-sm mb-0">Ring Road, Old Oba Road. | Email: admin@gmail.com | +23456789</p>
              <p class="text-sm text-secondary-light mb-0">Academic Session <span id="sessionYear">2025 - 2026</span></p>
            </div>

           <!-- Student Info -->
<div class="p-3">
  <div class="row justify-content-between">
    <div class="col-sm-6">
      <table class="text-sm text-secondary-light">
        <tbody>
          <tr><td>Name</td><td class="ps-8">: <span id="studentName">Loading...</span></td></tr>
          <tr><td>Gender</td><td class="ps-8">: <span id="studentGender">-</span></td></tr>
          <tr><td>Class</td><td class="ps-8">: <span id="studentClass">-</span></td></tr>
          <tr>
            <td>Term</td>
            <td class="ps-8">
              : 
              <select id="studentTerm" class="form-select form-select-sm d-inline w-auto">
                <option value="First Term">First Term</option>
                <option value="Second Term">Second Term</option>
                <option value="Third Term">Third Term</option>
                <option value="Yearly Summary">Yearly Summary</option>
              </select>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="col-sm-4 text-end">
      <p class="text-sm mb-0"><strong>Date Issued:</strong> <span id="dateIssued"></span></p>
      <p class="text-sm mb-0"><strong>Issued By:</strong> Damotak Admin</p>
    </div>
  </div>
</div>

<!-- Subjects Table -->
<div class="p-3">
  <div class="table-responsive scroll-sm">
    <table class="table bordered-table text-sm" id="resultTable">
      <thead>
        <tr>
          <th>SL.</th>
          <th>SUBJECT</th>
          <th>MARK OBTAINABLE (CA)</th>
          <th>C.A</th>
          <th>MARK OBTAINABLE (EXAM)</th>
          <th>EXAM</th>
          <th>TOTAL (100)</th>
          <th>GRADE</th>
          <th>REMARK</th>
          <th class="text-center">Action</th>
        </tr>
      </thead>
      <tbody id="resultTableBody">
        <!-- Dynamic Rows Appear Here -->
      </tbody>
    </table>
  </div>

  <button type="button" id="addRow" class="btn btn-sm btn-primary mt-3">
    <iconify-icon icon="simple-line-icons:plus" class="text-xl"></iconify-icon> Add New Subject
  </button>
</div>

<!-- Attendance Details Form -->
<div class="p-3 mt-4 border-top">
  <h6 class="text-md mb-3">Attendance Details</h6>
  <div class="row">
    <div class="col-md-4">
      <label for="daysOpened" class="form-label">Days Opened:</label>
      <input type="number" id="daysOpened" class="form-control" placeholder="Enter days opened" min="0">
    </div>
    <div class="col-md-4">
      <label for="daysPresent" class="form-label">Days Present:</label>
      <input type="number" id="daysPresent" class="form-control" placeholder="Enter days present" min="0">
    </div>
    <div class="col-md-4">
      <label for="daysAbsent" class="form-label">Days Absent:</label>
      <input type="number" id="daysAbsent" class="form-control" placeholder="Enter days absent" min="0">
    </div>
  </div>
  <div class="row mt-3">
    <div class="col-md-4">
      <label for="studentHeight" class="form-label">Height (cm):</label>
      <input type="number" id="studentHeight" class="form-control" placeholder="Enter height in cm" min="0">
    </div>
    <div class="col-md-4">
      <label for="studentWeight" class="form-label">Weight (kg):</label>
      <input type="number" id="studentWeight" class="form-control" placeholder="Enter weight in kg" min="0">
    </div>
    <div class="col-md-4">
      <label for="nextTermDate" class="form-label">Next Term Date:</label>
      <input type="date" id="nextTermDate" class="form-control">
    </div>
  </div>
</div>

<!-- Remarks -->
<div class="p-3 mt-4 border-top">
  <h6 class="text-md mb-2">Affective & Psychomotor Domain (A - E) grading scale</h6>
  <label>Neatness</label>
  <textarea id="Neatness" class="form-control mb-2" rows="1"></textarea>
  <label>Politeness:</label>
  <textarea id="Politeness" class="form-control" rows="1"></textarea>
  <label>Punctuality:</label>
  <textarea id="Punctuality" class="form-control" rows="1"></textarea>
  <label>Responsibility:</label>
  <textarea id="Responsibility" class="form-control" rows="1"></textarea>
  <label>Teamwork:</label>
  <textarea id="Teamwork" class="form-control" rows="1"></textarea>
  <label>Leadership:</label>
  <textarea id="Leadership" class="form-control" rows="1"></textarea>
  <label>Helping:</label>
  <textarea id="Helping" class="form-control" rows="1"></textarea>
  <label>Honesty:</label>
  <textarea id="Honesty" class="form-control" rows="1"></textarea>
  <label>Participation:</label>
  <textarea id="Participation" class="form-control" rows="1"></textarea>

  <br />

  <h6 class="text-md mb-2">School Remarks</h6>
  <label>Class Teacher Remark:</label>
  <textarea id="classTeacherRemark" class="form-control mb-2" rows="2"></textarea>
  <label>Head Teacher Remark:</label>
  <textarea id="headTeacherRemark" class="form-control" rows="2"></textarea>
</div>

<div class="p-3 d-flex justify-content-between mt-3">
  <span class="border-top px-3 text-sm">Class Teacher Signature</span>
  <span class="border-top px-3 text-sm">Headmaster Signature</span>
</div>

  
   <!-- ‚úÖ Notification Modal -->
  <div class="modal fade" id="notificationModal" tabindex="-1" aria-labelledby="notificationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content radius-12">
        <div class="modal-header">
          <h5 class="modal-title" id="notificationModalLabel">Notification</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="notificationMessage"></div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ‚úÖ Print Confirmation Modal -->
<div class="modal fade" id="printConfirmModal" tabindex="-1" aria-labelledby="printConfirmModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content radius-12">
      <div class="modal-header">
        <h5 class="modal-title" id="printConfirmModalLabel">Confirm Print</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        Are you sure you want to print this student's result?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No</button>
        <button type="button" class="btn btn-primary" id="confirmPrintBtn">Yes, Print</button>
      </div>
    </div>
  </div>
</div>



  <footer class="d-footer">
  <div class="row align-items-center justify-content-between">
    <div class="col-auto">
      <p class="mb-0">¬© 2025 DAMOTAK INTERNATIONAL SCHOOL. All Rights Reserved.</p>
    </div>
    <div class="col-auto">
      <p class="mb-0">Made by <span class="text-primary-600">DE-FLINTS</span></p>
    </div>
  </div>
</footer>
</main>
  
  <!-- jQuery library js -->
  <script src="assets/js/lib/jquery-3.7.1.min.js"></script>
  <!-- Bootstrap js -->
  <script src="assets/js/lib/bootstrap.bundle.min.js"></script>
  <!-- Apex Chart js -->
  <script src="assets/js/lib/apexcharts.min.js"></script>
  <!-- Data Table js -->
  <script src="assets/js/lib/dataTables.min.js"></script>
  <!-- Iconify Font js -->
  <script src="assets/js/lib/iconify-icon.min.js"></script>
  <!-- jQuery UI js -->
  <script src="assets/js/lib/jquery-ui.min.js"></script>
  <!-- Vector Map js -->
  <script src="assets/js/lib/jquery-jvectormap-2.0.5.min.js"></script>
  <script src="assets/js/lib/jquery-jvectormap-world-mill-en.js"></script>
  <!-- Popup js -->
  <script src="assets/js/lib/magnifc-popup.min.js"></script>
  <!-- Slick Slider js -->
  <script src="assets/js/lib/slick.min.js"></script>
  <!-- prism js -->
  <script src="assets/js/lib/prism.js"></script>
  <!-- file upload js -->
  <script src="assets/js/lib/file-upload.js"></script>
  <!-- audioplayer -->
  <script src="assets/js/lib/audioplayer.js"></script>
  
  <!-- main js -->
  <script src="assets/js/app.js"></script>
<script src="assets/js/invoice.js"></script>
<script type="module" src="assets/js/result-add.js"></script>
<script type="module" src="assets/js/result-save.js"></script>


</body>

</html>] andthe js [ // result-add.js
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";
import { saveResult } from "./result-save.js";

// ---------------------------
// Firebase Configs
// ---------------------------
const studentFirebaseConfig = {
  apiKey: "AIzaSyCz8GoyOi7wviejSPG2CGkOYvEwsaAWX0w",
  authDomain: "damotak-students-database.firebaseapp.com",
  databaseURL: "https://damotak-students-database-default-rtdb.firebaseio.com/",
  projectId: "damotak-students-database",
  storageBucket: "damotak-students-database.firebasestorage.app",
  messagingSenderId: "806502646085",
  appId: "1:806502646085:web:36a97f1d1e0ff4bab6be2c"
};

const resultFirebaseConfig = {
  apiKey: "AIzaSyDcrh8wVfeVwnOKnt-AcWDMOmxqNWe_0Uw",
  authDomain: "damotak-result-database.firebaseapp.com",
  databaseURL: "https://damotak-result-database-default-rtdb.firebaseio.com/",
  projectId: "damotak-result-database",
  storageBucket: "damotak-result-database.firebasestorage.app",
  messagingSenderId: "413754960869",
  appId: "1:413754960869:web:b3f51b6aaa0c667af0dd0c"
};

// ---------------------------
// Initialize Firebase Apps
// ---------------------------
const studentApp = initializeApp(studentFirebaseConfig, "studentDB");
const studentDb = getDatabase(studentApp);

const resultApp = initializeApp(resultFirebaseConfig, "resultDB");
const resultDb = getDatabase(resultApp);

// ---------------------------
// Page Setup
// ---------------------------
const urlParams = new URLSearchParams(window.location.search);
const studentID = urlParams.get("id");
document.getElementById("dateIssued").textContent = new Date().toLocaleDateString();

const tbody = document.getElementById("resultTableBody");

// ---------------------------
// Notification Helper
// ---------------------------
function showNotification(message, success) {
  const msgDiv = document.getElementById("notificationMessage");
  if (!msgDiv) return alert(message);
  msgDiv.textContent = message;
  msgDiv.style.color = success ? "green" : "red";
  new bootstrap.Modal(document.getElementById("notificationModal")).show();
}

// ---------------------------
// Load Student Info
// ---------------------------
async function loadStudent() {
  try {
    const snap = await get(ref(studentDb, `Students/${studentID}`));
    if (snap.exists()) {
      const data = snap.val();
      document.getElementById("studentName").textContent = data.name || "N/A";
      document.getElementById("studentClass").textContent = data.studentClass || "N/A";
      document.getElementById("studentGender").textContent = data.gender || "N/A";
    } else {
      showNotification("‚ùå Student not found!", false);
    }
  } catch (err) {
    showNotification("‚ö†Ô∏è Error loading student info: " + err.message, false);
  }
}
loadStudent();

// ---------------------------
// Table Functions
// ---------------------------
function addSubjectRow(subject = "", ca = "", exam = "", total = "0", grade = "-", remark = "-", readOnly = false) {
  const row = document.createElement("tr");
  row.innerHTML = `
   <td class="sl">${tbody.children.length + 1}</td>
   <td><input type="text" class="form-control subject-input" value="${subject}" ${readOnly ? "readonly" : ""}></td>
   <td><input type="number" class="form-control mark-ca" value="30" readonly></td>
   <td><input type="number" class="form-control ca-input" value="${ca}" min="0" max="30" ${readOnly ? "readonly" : ""}></td>
   <td><input type="number" class="form-control mark-exam" value="70" readonly></td>
   <td><input type="number" class="form-control exam-input" value="${exam}" min="0" max="70" ${readOnly ? "readonly" : ""}></td>
   <td class="total-score">${total}</td>
   <td class="grade">${grade}</td>
   <td class="remark">${remark}</td>
   <td class="text-center">${readOnly ? "" : '<button class="btn btn-danger btn-sm remove-row">‚úï</button>'}</td>
  `;
  tbody.appendChild(row);
  refreshRowNumbers();
}

function refreshRowNumbers() {
  Array.from(tbody.children).forEach((tr, i) => tr.querySelector(".sl").textContent = i + 1);
}

// ---------------------------
// Add / Remove Rows
// ---------------------------
document.getElementById("addRow").addEventListener("click", () => addSubjectRow());
tbody.addEventListener("click", (e) => {
  if (e.target.classList.contains("remove-row")) {
    e.target.closest("tr").remove();
    refreshRowNumbers();
  }
});

// ---------------------------
// Auto Calculate Grades
// ---------------------------
tbody.addEventListener("input", (e) => {
  if (e.target.classList.contains("ca-input") || e.target.classList.contains("exam-input")) {
    const tr = e.target.closest("tr");
    const ca = parseInt(tr.querySelector(".ca-input").value) || 0;
    const exam = parseInt(tr.querySelector(".exam-input").value) || 0;
    const total = ca + exam;
    let grade = "-", remark = "-";

    if (total >= 70) { grade = "A"; remark = "Excellent"; }
    else if (total >= 60) { grade = "B"; remark = "Very Good"; }
    else if (total >= 50) { grade = "C"; remark = "Good"; }
    else if (total >= 40) { grade = "D"; remark = "Fair"; }
    else { grade = "F"; remark = "Fail"; }

    tr.querySelector(".total-score").textContent = total;
    tr.querySelector(".grade").textContent = grade;
    tr.querySelector(".remark").textContent = remark;
  }
});

// ---------------------------
// Grade & Score Validation
// ---------------------------
tbody.addEventListener("input", (e) => {
  const target = e.target;
  const row = target.closest("tr");
  const caInput = row.querySelector(".ca-input");
  const examInput = row.querySelector(".exam-input");
  const totalCell = row.querySelector(".total-score");

  // CA Input Validation
  if (target.classList.contains("ca-input")) {
    let val = parseInt(caInput.value) || 0;
    if (val < 0) val = 0;
    if (val > 30) {
      alert("‚ùå CA cannot be more than 30. Resetting to 0.");
      caInput.value = 0;
      examInput.value = 0;
      totalCell.textContent = 0;
      row.querySelector(".grade").textContent = "-";
      row.querySelector(".remark").textContent = "-";
      return;
    }
    caInput.value = val;
    totalCell.textContent = val + (parseInt(examInput.value) || 0);
  }

  // Exam Input Validation
  if (target.classList.contains("exam-input")) {
    let val = parseInt(examInput.value) || 0;
    if (val < 0) val = 0;
    if (val > 70) {
      alert("‚ùå Exam cannot be more than 70. Resetting to 0.");
      examInput.value = 0;
      caInput.value = 0;
      totalCell.textContent = 0;
      row.querySelector(".grade").textContent = "-";
      row.querySelector(".remark").textContent = "-";
      return;
    }
    examInput.value = val;
    totalCell.textContent = val + (parseInt(caInput.value) || 0);
  }
});

// ---------------------------
// Prevent Saving if Invalid Grade
// ---------------------------
document.getElementById("saveResult").addEventListener("click", () => {
  let invalidGrade = false;
  tbody.querySelectorAll(".grade-input").forEach(input => {
    const val = input.value.toUpperCase();
    if (val && !["A","B","C","D","E"].includes(val)) invalidGrade = true;
  });

  if (invalidGrade) {
    return alert("‚ùå Cannot save. Some grade inputs are invalid! Only A, B, C, D, E are allowed.");
  }

  // ... your save logic here ...
});

// ---------------------------
// Attendance Input Validation
// ---------------------------
const attendanceInputs = ["daysOpened", "daysPresent", "daysAbsent", "studentHeight", "studentWeight"];
attendanceInputs.forEach(id => {
  const input = document.getElementById(id);

  input.addEventListener("input", (e) => {
    let val = e.target.value.replace(/\D/g, ""); // remove non-digit chars
    if (val.length > 3) val = val.slice(0, 3);   // max 3 digits
    e.target.value = val;
  });

  input.addEventListener("blur", (e) => {
    if (e.target.value !== "") e.target.value = parseInt(e.target.value, 10);
  });
});

// Attendance calculation: Days Opened = Present + Absent
const daysOpenedInput = document.getElementById("daysOpened");
const daysPresentInput = document.getElementById("daysPresent");
const daysAbsentInput = document.getElementById("daysAbsent");

function validateAttendance() {
  const opened = parseInt(daysOpenedInput.value) || 0;
  const present = parseInt(daysPresentInput.value) || 0;
  const absent = parseInt(daysAbsentInput.value) || 0;

  if (opened !== (present + absent)) {
    daysOpenedInput.setCustomValidity("Days Opened must equal Days Present + Days Absent");
    daysOpenedInput.reportValidity();
  } else {
    daysOpenedInput.setCustomValidity("");
  }
}

[daysOpenedInput, daysPresentInput, daysAbsentInput].forEach(input => {
  input.addEventListener("input", validateAttendance);
});

// ---------------------------
// Affective & Psychomotor Domain Validation
// ---------------------------
const remarkFields = [
  "Neatness", "Politeness", "Punctuality", "Responsibility",
  "Teamwork", "Leadership", "Helping", "Honesty", "Participation"
];

remarkFields.forEach(id => {
  const textarea = document.getElementById(id);
  textarea.addEventListener("input", (e) => {
    let val = e.target.value.toUpperCase();
    if (val.length > 1 || !["A", "B", "C", "D", "E"].includes(val)) {
      alert(`‚ùå Invalid input for ${id}! Only a single character A, B, C, D, or E is allowed.`);
      e.target.value = "";
    } else {
      e.target.value = val;
    }
  });
});


// ---------------------------
// Load Previous Results
// ---------------------------
async function loadPreviousResults() {
  const term = document.getElementById("studentTerm")?.value?.trim();
  if (!term || !studentID) return;

  try {
    const snapshot = await get(ref(resultDb, `Results/${studentID}/${term}`));
    tbody.innerHTML = "";

    if (snapshot.exists()) {
      const data = snapshot.val();
      const subjects = data.Subjects || {};
      Object.keys(subjects).forEach(sub => {
        const s = subjects[sub];
        addSubjectRow(s.subject || sub, s.ca || 0, s.exam || 0, s.total || 0, s.grade || "-", s.remark || "-", true);
      });

      document.getElementById("classTeacherRemark").value = data.classTeacherRemark || "";
      document.getElementById("headTeacherRemark").value = data.headTeacherRemark || "";
       document.getElementById("Neatness").value = data.Neatness || "";
        document.getElementById("Politeness").value = data.Politeness || "";
        document.getElementById("Punctuality").value = data.Punctuality || "";
         document.getElementById("Responsibility").value = data.Responsibility || "";
          document.getElementById("Teamwork").value = data.Teamwork || "";
           document.getElementById("Leadership").value = data.Leadership || "";
            document.getElementById("Helping").value = data.Helping || "";
             document.getElementById("Honesty").value = data.Honesty || "";
               document.getElementById("Participation").value = data.Participation || "";
                document.getElementById("daysOpened").value = data.daysOpened || "";
                 document.getElementById("daysPresent").value = data.daysPresent || "";
                  document.getElementById("daysAbsent").value = data.daysAbsent || "";
                   document.getElementById("studentHeight").value = data.studentHeight || "";
                    document.getElementById("studentWeight").value = data.studentWeight || "";
                     document.getElementById("nextTermDate").value = data.nextTermDate || "";
        
      showNotification("‚úÖ Loaded previous results!", true);
    } else {
      addSubjectRow();
      showNotification("‚ÑπÔ∏è No previous result found.", false);
    }
  } catch (err) {
    console.error(err);
    showNotification("‚ö†Ô∏è Failed to load results: " + err.message, false);
  }
}

document.getElementById("studentTerm").addEventListener("change", loadPreviousResults);
window.addEventListener("load", () => setTimeout(loadPreviousResults, 200));

// ---------------------------
// Save Result
// ---------------------------
document.getElementById("saveResult").addEventListener("click", async () => {
  const term = document.getElementById("studentTerm").value.trim();
  const classTeacherRemark = document.getElementById("classTeacherRemark").value.trim();
  const headTeacherRemark = document.getElementById("headTeacherRemark").value.trim();
  const Neatness = document.getElementById("Neatness").value.trim();
  const Politeness = document.getElementById("Politeness").value.trim();
  const Punctuality = document.getElementById("Punctuality").value.trim();
   const Responsibility = document.getElementById("Responsibility").value.trim();
    const Teamwork = document.getElementById("Teamwork").value.trim();
     const Leadership = document.getElementById("Leadership").value.trim();
      const Helping = document.getElementById("Helping").value.trim();
       const Honesty = document.getElementById("Honesty").value.trim();
        const Participation = document.getElementById("Participation").value.trim();
        const daysOpened = document.getElementById("daysOpened").value.trim();
        const daysPresent = document.getElementById("daysPresent").value.trim();
        const daysAbsent = document.getElementById("daysAbsent").value.trim();
        const studentHeight = document.getElementById("studentHeight").value.trim();
        const studentWeight = document.getElementById("studentWeight").value.trim();
         const nextTermDate = document.getElementById("nextTermDate").value.trim();
        


  const subjects = [];
  tbody.querySelectorAll("tr").forEach(tr => {
    const subject = tr.querySelector(".subject-input").value.trim();
    const ca = parseInt(tr.querySelector(".ca-input").value) || 0;
    const exam = parseInt(tr.querySelector(".exam-input").value) || 0;
    const total = ca + exam;
    const grade = tr.querySelector(".grade").textContent || "-";
    const remark = tr.querySelector(".remark").textContent || "-";
    if (subject && !tr.querySelector(".subject-input").readOnly) {
      subjects.push({ subject, ca, exam, total, grade, remark });
    }
  });

  if (!subjects.length && !classTeacherRemark.length) {
    return showNotification("‚ö†Ô∏è Add at least one new subject or comment before saving.", false);
  }
  
 

  const resultData = {
    studentID,
    term,
    classTeacherRemark,
    headTeacherRemark,
    Neatness,
    Politeness,
    Punctuality,
    Responsibility,
    Teamwork,
    Leadership,
    Helping,
    Honesty,
    Participation,
    daysOpened,
    daysPresent,
    daysAbsent,
    studentHeight,
    studentWeight,
    nextTermDate,
    dateIssued: new Date().toLocaleDateString(),
    subjects
  };

  const res = await saveResult(studentID, term, resultData);
  showNotification(res.message, res.success);
  if (res.success) setTimeout(loadPreviousResults, 400);
});

// ---------------------------
// Print Result Function (Auto Print After 2s + Dynamic File Name)
// ---------------------------
document.getElementById("PrintResult").addEventListener("click", () => {
  const modal = new bootstrap.Modal(document.getElementById("printConfirmModal"));
  modal.show();

  document.getElementById("confirmPrintBtn").onclick = () => {
    modal.hide();

    // Hide "Add New Subject" button temporarily
    const addSubjectBtn = document.getElementById("addRow");
    if (addSubjectBtn) addSubjectBtn.style.display = "none";

    // Clone and clean result table
    const resultTable = document.getElementById("resultTable").cloneNode(true);

    // Remove "Action" column
    const headerRow = resultTable.querySelector("thead tr");
    if (headerRow && headerRow.lastElementChild.textContent.trim().toLowerCase() === "action") {
      headerRow.removeChild(headerRow.lastElementChild);
    }

    // Remove "Action" cells in body
    resultTable.querySelectorAll("tbody tr").forEach(row => {
      if (row.lastElementChild) row.removeChild(row.lastElementChild);
    });

    // Convert inputs to plain text
    resultTable.querySelectorAll("input, select").forEach(el => {
      const td = el.parentElement;
      td.textContent = el.value || "-";
    });

    // Get student info
    const studentName = document.getElementById("studentName").textContent.trim();
    const studentGender = document.getElementById("studentGender").textContent.trim();
    const studentClass = document.getElementById("studentClass").textContent.trim();
    const term = document.getElementById("studentTerm").value || document.getElementById("studentTerm").textContent.trim();
    const dateIssued = document.getElementById("dateIssued").textContent.trim();
    const sessionYear = document.getElementById("sessionYear")?.textContent.trim() || "2025/2026";
    const classRemark = document.getElementById("classTeacherRemark").value || "-";
    const headRemark = document.getElementById("headTeacherRemark").value || "-";
    const Neatness = document.getElementById("Neatness")?.value || "-";
    const Politeness = document.getElementById("Politeness")?.value || "-";
    const Punctuality = document.getElementById("Punctuality")?.value || "-";
    const Responsibility = document.getElementById("Responsibility")?.value || "-";
    const Leadership = document.getElementById("Leadership")?.value || "-";
    const Helping = document.getElementById("Helping")?.value || "-";
    const Honesty = document.getElementById("Honesty")?.value || "-";
    const Teamwork = document.getElementById("Teamwork")?.value || "-";
    const daysOpened = document.getElementById("daysOpened")?.value || "-";
    const daysPresent = document.getElementById("daysPresent")?.value || "-";
    const daysAbsent = document.getElementById("daysAbsent")?.value || "-";
    const studentHeight = document.getElementById("studentHeight")?.value || "-";
    const studentWeight = document.getElementById("studentWeight")?.value || "-";
    const nextTermDate = document.getElementById("nextTermDate")?.value || "-";

    // Calculate total and average
    const totals = Array.from(resultTable.querySelectorAll(".total-score")).map(td => parseInt(td.textContent) || 0);
    const totalScore = totals.reduce((a, b) => a + b, 0);
    const avgScore = totals.length ? (totalScore / totals.length).toFixed(2) : "0.00";

    // Build print window
    const printWindow = window.open("", "_blank", "width=900,height=1000");
    printWindow.document.open();
    printWindow.document.write(`
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Student Result | Damotak International School</title>
<style>
  body {
    font-family: "Segoe UI", "Calibri", sans-serif;
    background: linear-gradient(135deg, #f7f9fc, #eef2f7);
    color: #2c3e50;
    margin: 30px;
    line-height: 1.6;
    position: relative;
  }

  /* Watermark */
  body::before {
    content: "";
    position: fixed;
    top: 50%;
    left: 50%;
    width: 750px;
    height: 750px;
    background: url('assets/images/auth/Damotak Logo.png') no-repeat center center;
    background-size: 60%;
    opacity: 0.05;
    transform: translate(-50%, -50%);
    z-index: -1;
  }

  .school-logo {
  border: 3px solid #0047AB; /* change color as you like */
  border-radius: 12px;        /* rounded corners, 0 for sharp edges */
  padding: 5px;               /* space between border and image */
  width: 150px;               /* adjust size */
  height: auto;               /* maintain aspect ratio */
  box-shadow: 0 4px 8px rgba(0,0,0,0.2); /* subtle shadow for sharp look */
  display: block;             /* center with margin if needed */
  margin: 20px auto;          /* centers image horizontally */
}

  .header {
    text-align: center;
    margin-bottom: 35px;
    position: relative;
  }
  .header img { width: 100px; margin-bottom: 10px; }
  .header h3 { margin: 5px 0; color: #1c3d72; text-transform: uppercase; letter-spacing: 1px; }
  .header p { margin: 2px 0; font-size: 13px; }

  .header::after {
    content: "";
    position: absolute;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 80%;
    height: 3px;
    background: linear-gradient(to right, #1c3d72, #2a4d69);
    border-radius: 5px;
  }
  
  .col h4,
.col ul {
  text-transform: uppercase; /* Make text uppercase */
}
 

  .row { display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 25px; }
  .col {
    flex: 1; min-width: 250px; background: #fff;
    border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.07);
    padding: 15px 20px;
  }
  .col h4 { margin-bottom: 8px; font-size: 14px; text-transform: uppercase; color: #fff; background: #1c3d72; padding: 5px 10px; border-radius: 5px 5px 0 0; }
  .col ul { list-style: none; padding: 10px 0 0 0; margin: 0; }
  .col ul li { margin: 4px 0; font-size: 13px; }
  .col ul li strong { color: #1c3d72; }

  table {
    width: 100%; border-collapse: collapse; margin-bottom: 25px;
    background: #fff; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
  }
  th {
    background: #1c3d72; color: #fff; padding: 6px; font-size: 13px; text-align: center;
  }
  td {
    text-align: center; padding: 6px; border-bottom: 1px solid #eef2f7; font-size: 13px;
  }
  tr:nth-child(even) td { background: #f9fbff; }
  .grade-tick { color: #1c3d72; font-size: 16px; }

  .section-title {
    font-weight: 700; margin: 25px 0 10px 0; font-size: 16px;
    color: #1c3d72; text-transform: uppercase; letter-spacing: 0.5px;
    border-left: 5px solid #1c3d72; padding-left: 10px;
  }

  .signatures { display: flex; justify-content: space-between; margin-top: 40px; }
  .sign {
    border-top: 2px solid #1c3d72; width: 45%; text-align: center;
    padding-top: 8px; font-size: 13px; color: #1c3d72; font-weight: 600;
  }

  @media print {
    body { background: #fff; -webkit-print-color-adjust: exact; }
    @page { size: A4; margin: 1cm; }
  }
    
  #resultTable td:nth-child(2),
  #resultTable th:nth-child(2),
  #resultTableBody input[name="subject"],
  #resultTableBody select[name="subject"] {
    text-transform: uppercase !important;
  }

</style>
</head>
<body>

<div class="header">
  <img src="assets/images/auth/Damotak Logo.png" alt="School Logo" class="school-logo">

  <h3>Damotak International School</h3>
  <p>NEW OBA ROAD, ILE-IDANDE AREA, OKE-ONITEA | Email: DamotakInc@gmail.com | 08033880730</p>
  <p><strong>Academic Session:</strong> ${sessionYear}</p>
</div>

<div class="row">
  <div class="col">
    <h4>Student Details</h4>
    <ul>
      <li><strong>Name:</strong> ${studentName}</li>
      <li><strong>Gender:</strong> ${studentGender}</li>
      <li><strong>Class:</strong> ${studentClass}</li>
      <li><strong>Term:</strong> ${term}</li>
      <li><strong>Student ID:</strong> ${studentID}</li>
      <li><strong>Date Issued:</strong> ${dateIssued}</li>
    </ul>
  </div>
  <div class="col">
    <h4>Attendance & Physical Record</h4>
    <ul>
      <li><strong>Days Opened:</strong> ${daysOpened}</li>
      <li><strong>Days Present:</strong> ${daysPresent}</li>
      <li><strong>Days Absent:</strong> ${daysAbsent}</li>
      <li><strong>Height:</strong> ${studentHeight} cm</li>
      <li><strong>Weight:</strong> ${studentWeight} kg</li>
      <li><strong>Next Term Begins:</strong> ${nextTermDate}</li>
    </ul>
  </div>
</div>

<div class="section-title">Subjects and Scores</div>
${resultTable.outerHTML}

<div class="row">
  <div class="col">
    <h4>Summary</h4>
    <ul>
      <li><strong>Total Marks:</strong> ${totalScore}</li>
      <li><strong>Average Score:</strong> ${avgScore}%</li>
    </ul>
  </div>
  <div class="col">
    <h4>Remarks</h4>
    <ul>
      <li><strong>Class Teacher:</strong> ${classRemark}</li>
      <li><strong>Head Teacher:</strong> ${headRemark}</li>
    </ul>
  </div>
</div>

<!-- AFFECTIVE & PSYCHOMOTOR -->

<div class="section-title">Affective & Psychomotor Domain (A - E)</div>

<table>

<thead>

<tr>

<th>Area</th>

<th>A</th>

<th>B</th>

<th>C</th>

<th>D</th>

<th>E</th>

</tr>

</thead>

<tbody>

<tr>

<td>Neatness</td>

<td class="grade-tick">${Neatness=='A'?'‚úîÔ∏è':''}</td>

<td class="grade-tick">${Neatness=='B'?'‚úîÔ∏è':''}</td>

<td class="grade-tick">${Neatness=='C'?'‚úîÔ∏è':''}</td>

<td class="grade-tick">${Neatness=='D'?'‚úîÔ∏è':''}</td>

<td class="grade-tick">${Neatness=='E'?'‚úîÔ∏è':''}</td>

</tr>

<tr>

<td>Politeness</td>

<td class="grade-tick">${Politeness=='A'?'‚úîÔ∏è':''}</td>

<td class="grade-tick">${Politeness=='B'?'‚úîÔ∏è':''}</td>

<td class="grade-tick">${Politeness=='C'?'‚úîÔ∏è':''}</td>

<td class="grade-tick">${Politeness=='D'?'‚úîÔ∏è':''}</td>

<td class="grade-tick">${Politeness=='E'?'‚úîÔ∏è':''}</td>

</tr>

<tr>

<td>Punctuality</td>

<td class="grade-tick">${Punctuality=='A'?'‚úîÔ∏è':''}</td>

<td class="grade-tick">${Punctuality=='B'?'‚úîÔ∏è':''}</td>

<td class="grade-tick">${Punctuality=='C'?'‚úîÔ∏è':''}</td>

<td class="grade-tick">${Punctuality=='D'?'‚úîÔ∏è':''}</td>

<td class="grade-tick">${Punctuality=='E'?'‚úîÔ∏è':''}</td>

</tr>

<tr>

<td>Responsibility</td>

<td class="grade-tick">${Responsibility=='A'?'‚úîÔ∏è':''}</td>

<td class="grade-tick">${Responsibility=='B'?'‚úîÔ∏è':''}</td>

<td class="grade-tick">${Responsibility=='C'?'‚úîÔ∏è':''}</td>

<td class="grade-tick">${Responsibility=='D'?'‚úîÔ∏è':''}</td>

<td class="grade-tick">${Responsibility=='E'?'‚úîÔ∏è':''}</td>

</tr>

<tr>

<td>Teamwork</td>

<td class="grade-tick">${Teamwork=='A'?'‚úîÔ∏è':''}</td>

<td class="grade-tick">${Teamwork=='B'?'‚úîÔ∏è':''}</td>

<td class="grade-tick">${Teamwork=='C'?'‚úîÔ∏è':''}</td>

<td class="grade-tick">${Teamwork=='D'?'‚úîÔ∏è':''}</td>

<td class="grade-tick">${Teamwork=='E'?'‚úîÔ∏è':''}</td>

</tr>

<tr>

<td>Leadership</td>

<td class="grade-tick">${Leadership=='A'?'‚úîÔ∏è':''}</td>

<td class="grade-tick">${Leadership=='B'?'‚úîÔ∏è':''}</td>

<td class="grade-tick">${Leadership=='C'?'‚úîÔ∏è':''}</td>

<td class="grade-tick">${Leadership=='D'?'‚úîÔ∏è':''}</td>

<td class="grade-tick">${Leadership=='E'?'‚úîÔ∏è':''}</td>

</tr>

<tr>

<td>Helping Others</td>

<td class="grade-tick">${Helping=='A'?'‚úîÔ∏è':''}</td>

<td class="grade-tick">${Helping=='B'?'‚úîÔ∏è':''}</td>

<td class="grade-tick">${Helping=='C'?'‚úîÔ∏è':''}</td>

<td class="grade-tick">${Helping=='D'?'‚úîÔ∏è':''}</td>

<td class="grade-tick">${Helping=='E'?'‚úîÔ∏è':''}</td>

</tr>

</tbody>

</table>

<!-- ADDITIONAL GRADING TABLES -->

<div class="section-title">System Grading</div>

<table>

<thead>

<tr>

<th>Grade</th>

<th>Score Range</th>

<th>Description</th>

</tr>

</thead>

<tbody>

<tr><td>A</td><td>75-100</td><td>Excellent</td></tr>

<tr><td>B</td><td>60-74</td><td>Very Good</td></tr>

<tr><td>C</td><td>50-59</td><td>Good</td></tr>

<tr><td>D</td><td>40-49</td><td>Pass</td></tr>

<tr><td>E</td><td>0-39</td><td>Fail</td></tr>

</tbody>

</table>

<BR>

<BR>

<div class="signatures">
  <div class="sign">Class Teacher‚Äôs Signature</div>
  <div class="sign">Headmaster‚Äôs Signature</div>
</div>

</body>
</html>
    `);
    printWindow.document.close();

    // Print logic
    printWindow.onload = () => {
      const fileTitle = `${studentName.replace(/\s+/g, "_")}_${studentID}_Result`;
      printWindow.document.title = fileTitle;

      setTimeout(() => {
        printWindow.focus();
        printWindow.print();
      }, 2000);

      printWindow.onafterprint = printWindow.onbeforeunload = () => {
        printWindow.close();
        location.href = "result-add.html";
      };
    };

    setTimeout(() => {
      if (addSubjectBtn) addSubjectBtn.style.display = "inline-block";
    }, 3000);
  };
});




// ---------------------------
// Navigation Buttons
// ---------------------------
document.getElementById("backBtn").addEventListener("click", () => window.location.href = "result-list.html"); ]

// result-add.js
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";
import { saveResult } from "./result-save.js";

// ---------------------------
// Firebase Configs
// ---------------------------
const studentFirebaseConfig = {
  apiKey: "AIzaSyCz8GoyOi7wviejSPG2CGkOYvEwsaAWX0w",
  authDomain: "damotak-students-database.firebaseapp.com",
  databaseURL: "https://damotak-students-database-default-rtdb.firebaseio.com/",
  projectId: "damotak-students-database",
  storageBucket: "damotak-students-database.firebasestorage.app",
  messagingSenderId: "806502646085",
  appId: "1:806502646085:web:36a97f1d1e0ff4bab6be2c"
};

const resultFirebaseConfig = {
  apiKey: "AIzaSyDcrh8wVfeVwnOKnt-AcWDMOmxqNWe_0Uw",
  authDomain: "damotak-result-database.firebaseapp.com",
  databaseURL: "https://damotak-result-database-default-rtdb.firebaseio.com/",
  projectId: "damotak-result-database",
  storageBucket: "damotak-result-database.firebasestorage.app",
  messagingSenderId: "413754960869",
  appId: "1:413754960869:web:b3f51b6aaa0c667af0dd0c"
};

// ---------------------------
// Initialize Firebase Apps
// ---------------------------
const studentApp = initializeApp(studentFirebaseConfig, "studentDB");
const studentDb = getDatabase(studentApp);

const resultApp = initializeApp(resultFirebaseConfig, "resultDB");
const resultDb = getDatabase(resultApp);

// ---------------------------
// Page Setup
// ---------------------------
const urlParams = new URLSearchParams(window.location.search);
const studentID = urlParams.get("id");
document.getElementById("dateIssued").textContent = new Date().toLocaleDateString();

const tbody = document.getElementById("resultTableBody");

// ---------------------------
// Notification Helper (Updated)
// ---------------------------
function showNotification(message, success) {
  const msgDiv = document.getElementById("notificationMessage");
  if (!msgDiv) return alert(message);

  msgDiv.textContent = message;
  msgDiv.style.color = success ? "green" : "red";

  const modalEl = document.getElementById("notificationModal");
  let modal = bootstrap.Modal.getInstance(modalEl);

  if (!modal) modal = new bootstrap.Modal(modalEl);

  modal.show();

  // Remove lingering backdrop when modal closes
  modalEl.addEventListener('hidden.bs.modal', () => {
    document.body.classList.remove('modal-open');
    const backdrop = document.querySelector('.modal-backdrop');
    if (backdrop) backdrop.remove();
  }, { once: true }); // ensure this runs only once per show
}

// ---------------------------
// Term Change Logic (Updated)
// ---------------------------
document.getElementById("studentTerm").addEventListener("change", async (e) => {
  const term = e.target.value;

  // Hide any open modals & remove backdrops first
  const modals = document.querySelectorAll('.modal.show');
  modals.forEach(m => bootstrap.Modal.getInstance(m)?.hide());
  document.querySelectorAll('.modal-backdrop').forEach(b => b.remove());
  document.body.classList.remove('modal-open');

  if (term === "Yearly Summary") {
    yearlySummaryContainer.style.display = "block"; // show yearly summary
    document.getElementById("resultTable").parentElement.style.display = "none"; // hide term table
    await loadYearlySummary(); // load yearly summary
  } else {
    yearlySummaryContainer.style.display = "none"; // hide yearly summary
    document.getElementById("resultTable").parentElement.style.display = "block"; // show term table
    await loadPreviousResults(term); // load selected term
  }
});


// ---------------------------
// Load Student Info
// ---------------------------
async function loadStudent() {
  try {
    const snap = await get(ref(studentDb, `Students/${studentID}`));
    if (snap.exists()) {
      const data = snap.val();
      document.getElementById("studentName").textContent = data.name || "N/A";
      document.getElementById("studentClass").textContent = data.studentClass || "N/A";
      document.getElementById("studentGender").textContent = data.gender || "N/A";
    } else {
      showNotification("‚ùå Student not found!", false);
    }
  } catch (err) {
    showNotification("‚ö†Ô∏è Error loading student info: " + err.message, false);
  }
}
loadStudent();

// ---------------------------
// Table Functions
// ---------------------------
function addSubjectRow(subject = "", ca = "", exam = "", total = "0", grade = "-", remark = "-", readOnly = false) {
  const row = document.createElement("tr");
  row.innerHTML = `
   <td class="sl">${tbody.children.length + 1}</td>
   <td><input type="text" class="form-control subject-input" value="${subject}" ${readOnly ? "readonly" : ""}></td>
   <td><input type="number" class="form-control mark-ca" value="30" readonly></td>
   <td><input type="number" class="form-control ca-input" value="${ca}" min="0" max="30" ${readOnly ? "readonly" : ""}></td>
   <td><input type="number" class="form-control mark-exam" value="70" readonly></td>
   <td><input type="number" class="form-control exam-input" value="${exam}" min="0" max="70" ${readOnly ? "readonly" : ""}></td>
   <td class="total-score">${total}</td>
   <td class="grade">${grade}</td>
   <td class="remark">${remark}</td>
   <td class="text-center">${readOnly ? "" : '<button class="btn btn-danger btn-sm remove-row">‚úï</button>'}</td>
  `;
  tbody.appendChild(row);
  refreshRowNumbers();
}

function refreshRowNumbers() {
  Array.from(tbody.children).forEach((tr, i) => tr.querySelector(".sl").textContent = i + 1);
}

// ---------------------------
// Add / Remove Rows
// ---------------------------
document.getElementById("addRow").addEventListener("click", () => addSubjectRow());
tbody.addEventListener("click", (e) => {
  if (e.target.classList.contains("remove-row")) {
    e.target.closest("tr").remove();
    refreshRowNumbers();
  }
});

// ---------------------------
// Auto Calculate Grades
// ---------------------------
tbody.addEventListener("input", (e) => {
  if (e.target.classList.contains("ca-input") || e.target.classList.contains("exam-input")) {
    const tr = e.target.closest("tr");
    const ca = parseInt(tr.querySelector(".ca-input").value) || 0;
    const exam = parseInt(tr.querySelector(".exam-input").value) || 0;
    const total = ca + exam;
    let grade = "-", remark = "-";

    if (total >= 70) { grade = "A"; remark = "Excellent"; }
    else if (total >= 60) { grade = "B"; remark = "Very Good"; }
    else if (total >= 50) { grade = "C"; remark = "Good"; }
    else if (total >= 40) { grade = "D"; remark = "Fair"; }
    else { grade = "F"; remark = "Fail"; }

    tr.querySelector(".total-score").textContent = total;
    tr.querySelector(".grade").textContent = grade;
    tr.querySelector(".remark").textContent = remark;
  }
});

// ---------------------------
// Grade & Score Validation
// ---------------------------
tbody.addEventListener("input", (e) => {
  const target = e.target;
  const row = target.closest("tr");
  const caInput = row.querySelector(".ca-input");
  const examInput = row.querySelector(".exam-input");
  const totalCell = row.querySelector(".total-score");

  // CA Input Validation
  if (target.classList.contains("ca-input")) {
    let val = parseInt(caInput.value) || 0;
    if (val < 0) val = 0;
    if (val > 30) {
      alert("‚ùå CA cannot be more than 30. Resetting to 0.");
      caInput.value = 0;
      examInput.value = 0;
      totalCell.textContent = 0;
      row.querySelector(".grade").textContent = "-";
      row.querySelector(".remark").textContent = "-";
      return;
    }
    caInput.value = val;
    totalCell.textContent = val + (parseInt(examInput.value) || 0);
  }

  // Exam Input Validation
  if (target.classList.contains("exam-input")) {
    let val = parseInt(examInput.value) || 0;
    if (val < 0) val = 0;
    if (val > 70) {
      alert("‚ùå Exam cannot be more than 70. Resetting to 0.");
      examInput.value = 0;
      caInput.value = 0;
      totalCell.textContent = 0;
      row.querySelector(".grade").textContent = "-";
      row.querySelector(".remark").textContent = "-";
      return;
    }
    examInput.value = val;
    totalCell.textContent = val + (parseInt(caInput.value) || 0);
  }
});

// ---------------------------
// Prevent Saving if Invalid Grade
// ---------------------------
document.getElementById("saveResult").addEventListener("click", () => {
  let invalidGrade = false;
  tbody.querySelectorAll(".grade-input").forEach(input => {
    const val = input.value.toUpperCase();
    if (val && !["A","B","C","D","E"].includes(val)) invalidGrade = true;
  });

  if (invalidGrade) {
    return alert("‚ùå Cannot save. Some grade inputs are invalid! Only A, B, C, D, E are allowed.");
  }

  // ... your save logic here ...
});

// ---------------------------
// Attendance Input Validation
// ---------------------------
const attendanceInputs = ["daysOpened", "daysPresent", "daysAbsent", "studentHeight", "studentWeight"];
attendanceInputs.forEach(id => {
  const input = document.getElementById(id);

  input.addEventListener("input", (e) => {
    let val = e.target.value.replace(/\D/g, ""); // remove non-digit chars
    if (val.length > 3) val = val.slice(0, 3);   // max 3 digits
    e.target.value = val;
  });

  input.addEventListener("blur", (e) => {
    if (e.target.value !== "") e.target.value = parseInt(e.target.value, 10);
  });
});

// Attendance calculation: Days Opened = Present + Absent
const daysOpenedInput = document.getElementById("daysOpened");
const daysPresentInput = document.getElementById("daysPresent");
const daysAbsentInput = document.getElementById("daysAbsent");

function validateAttendance() {
  const opened = parseInt(daysOpenedInput.value) || 0;
  const present = parseInt(daysPresentInput.value) || 0;
  const absent = parseInt(daysAbsentInput.value) || 0;

  if (opened !== (present + absent)) {
    daysOpenedInput.setCustomValidity("Days Opened must equal Days Present + Days Absent");
    daysOpenedInput.reportValidity();
  } else {
    daysOpenedInput.setCustomValidity("");
  }
}

[daysOpenedInput, daysPresentInput, daysAbsentInput].forEach(input => {
  input.addEventListener("input", validateAttendance);
});

// ---------------------------
// Affective & Psychomotor Domain Validation
// ---------------------------
const remarkFields = [
  "Neatness", "Politeness", "Punctuality", "Responsibility",
  "Teamwork", "Leadership", "Helping", "Honesty", "Participation"
];

remarkFields.forEach(id => {
  const textarea = document.getElementById(id);
  textarea.addEventListener("input", (e) => {
    let val = e.target.value.toUpperCase();
    if (val.length > 1 || !["A", "B", "C", "D", "E"].includes(val)) {
      alert(`‚ùå Invalid input for ${id}! Only a single character A, B, C, D, or E is allowed.`);
      e.target.value = "";
    } else {
      e.target.value = val;
    }
  });
});


// ---------------------------
// Load Previous Results
// ---------------------------
async function loadPreviousResults() {
  const term = document.getElementById("studentTerm")?.value?.trim();
  if (!term || !studentID) return;

  try {
    const snapshot = await get(ref(resultDb, `Results/${studentID}/${term}`));
    tbody.innerHTML = "";

    if (snapshot.exists()) {
      const data = snapshot.val();
      const subjects = data.Subjects || {};
      Object.keys(subjects).forEach(sub => {
        const s = subjects[sub];
        addSubjectRow(s.subject || sub, s.ca || 0, s.exam || 0, s.total || 0, s.grade || "-", s.remark || "-", true);
      });

      document.getElementById("classTeacherRemark").value = data.classTeacherRemark || "";
      document.getElementById("headTeacherRemark").value = data.headTeacherRemark || "";
       document.getElementById("Neatness").value = data.Neatness || "";
        document.getElementById("Politeness").value = data.Politeness || "";
        document.getElementById("Punctuality").value = data.Punctuality || "";
         document.getElementById("Responsibility").value = data.Responsibility || "";
          document.getElementById("Teamwork").value = data.Teamwork || "";
           document.getElementById("Leadership").value = data.Leadership || "";
            document.getElementById("Helping").value = data.Helping || "";
             document.getElementById("Honesty").value = data.Honesty || "";
               document.getElementById("Participation").value = data.Participation || "";
                document.getElementById("daysOpened").value = data.daysOpened || "";
                 document.getElementById("daysPresent").value = data.daysPresent || "";
                  document.getElementById("daysAbsent").value = data.daysAbsent || "";
                   document.getElementById("studentHeight").value = data.studentHeight || "";
                    document.getElementById("studentWeight").value = data.studentWeight || "";
                     document.getElementById("nextTermDate").value = data.nextTermDate || "";
        
      showNotification("‚úÖ Loaded previous results!", true);
    } else {
      addSubjectRow();
      showNotification("‚ÑπÔ∏è No previous result found.", false);
    }
  } catch (err) {
    console.error(err);
    showNotification("‚ö†Ô∏è Failed to load results: " + err.message, false);
  }
}

document.getElementById("studentTerm").addEventListener("change", loadPreviousResults);
window.addEventListener("load", () => setTimeout(loadPreviousResults, 200));

// ---------------------------
// Save Result
// ---------------------------
document.getElementById("saveResult").addEventListener("click", async () => {
  const term = document.getElementById("studentTerm").value.trim();
  const classTeacherRemark = document.getElementById("classTeacherRemark").value.trim();
  const headTeacherRemark = document.getElementById("headTeacherRemark").value.trim();
  const Neatness = document.getElementById("Neatness").value.trim();
  const Politeness = document.getElementById("Politeness").value.trim();
  const Punctuality = document.getElementById("Punctuality").value.trim();
   const Responsibility = document.getElementById("Responsibility").value.trim();
    const Teamwork = document.getElementById("Teamwork").value.trim();
     const Leadership = document.getElementById("Leadership").value.trim();
      const Helping = document.getElementById("Helping").value.trim();
       const Honesty = document.getElementById("Honesty").value.trim();
        const Participation = document.getElementById("Participation").value.trim();
        const daysOpened = document.getElementById("daysOpened").value.trim();
        const daysPresent = document.getElementById("daysPresent").value.trim();
        const daysAbsent = document.getElementById("daysAbsent").value.trim();
        const studentHeight = document.getElementById("studentHeight").value.trim();
        const studentWeight = document.getElementById("studentWeight").value.trim();
         const nextTermDate = document.getElementById("nextTermDate").value.trim();
        


  const subjects = [];
  tbody.querySelectorAll("tr").forEach(tr => {
    const subject = tr.querySelector(".subject-input").value.trim();
    const ca = parseInt(tr.querySelector(".ca-input").value) || 0;
    const exam = parseInt(tr.querySelector(".exam-input").value) || 0;
    const total = ca + exam;
    const grade = tr.querySelector(".grade").textContent || "-";
    const remark = tr.querySelector(".remark").textContent || "-";
    if (subject && !tr.querySelector(".subject-input").readOnly) {
      subjects.push({ subject, ca, exam, total, grade, remark });
    }
  });

  if (!subjects.length && !classTeacherRemark.length) {
    return showNotification("‚ö†Ô∏è Add at least one new subject or comment before saving.", false);
  }
  
 

  const resultData = {
    studentID,
    term,
    classTeacherRemark,
    headTeacherRemark,
    Neatness,
    Politeness,
    Punctuality,
    Responsibility,
    Teamwork,
    Leadership,
    Helping,
    Honesty,
    Participation,
    daysOpened,
    daysPresent,
    daysAbsent,
    studentHeight,
    studentWeight,
    nextTermDate,
    dateIssued: new Date().toLocaleDateString(),
    subjects
  };

  const res = await saveResult(studentID, term, resultData);
  showNotification(res.message, res.success);
  if (res.success) setTimeout(loadPreviousResults, 400);
});

// ---------------------------
// Print Result Function (Auto Print After 2s + Dynamic File Name)
// ---------------------------
document.getElementById("PrintResult").addEventListener("click", () => {
  const modal = new bootstrap.Modal(document.getElementById("printConfirmModal"));
  modal.show();

  document.getElementById("confirmPrintBtn").onclick = () => {
    modal.hide();

    // Hide "Add New Subject" button temporarily
    const addSubjectBtn = document.getElementById("addRow");
    if (addSubjectBtn) addSubjectBtn.style.display = "none";

    // Clone and clean result table
    const resultTable = document.getElementById("resultTable").cloneNode(true);

    // Remove "Action" column
    const headerRow = resultTable.querySelector("thead tr");
    if (headerRow && headerRow.lastElementChild.textContent.trim().toLowerCase() === "action") {
      headerRow.removeChild(headerRow.lastElementChild);
    }

    // Remove "Action" cells in body
    resultTable.querySelectorAll("tbody tr").forEach(row => {
      if (row.lastElementChild) row.removeChild(row.lastElementChild);
    });

    // Convert inputs to plain text
    resultTable.querySelectorAll("input, select").forEach(el => {
      const td = el.parentElement;
      td.textContent = el.value || "-";
    });

    // Get student info
    const studentName = document.getElementById("studentName").textContent.trim();
    const studentGender = document.getElementById("studentGender").textContent.trim();
    const studentClass = document.getElementById("studentClass").textContent.trim();
    const term = document.getElementById("studentTerm").value || document.getElementById("studentTerm").textContent.trim();
    const dateIssued = document.getElementById("dateIssued").textContent.trim();
    const sessionYear = document.getElementById("sessionYear")?.textContent.trim() || "2025/2026";
    const classRemark = document.getElementById("classTeacherRemark").value || "-";
    const headRemark = document.getElementById("headTeacherRemark").value || "-";
    const Neatness = document.getElementById("Neatness")?.value || "-";
    const Politeness = document.getElementById("Politeness")?.value || "-";
    const Punctuality = document.getElementById("Punctuality")?.value || "-";
    const Responsibility = document.getElementById("Responsibility")?.value || "-";
    const Leadership = document.getElementById("Leadership")?.value || "-";
    const Helping = document.getElementById("Helping")?.value || "-";
    const Honesty = document.getElementById("Honesty")?.value || "-";
    const Teamwork = document.getElementById("Teamwork")?.value || "-";
    const daysOpened = document.getElementById("daysOpened")?.value || "-";
    const daysPresent = document.getElementById("daysPresent")?.value || "-";
    const daysAbsent = document.getElementById("daysAbsent")?.value || "-";
    const studentHeight = document.getElementById("studentHeight")?.value || "-";
    const studentWeight = document.getElementById("studentWeight")?.value || "-";
    const nextTermDate = document.getElementById("nextTermDate")?.value || "-";

    // Calculate total and average
    const totals = Array.from(resultTable.querySelectorAll(".total-score")).map(td => parseInt(td.textContent) || 0);
    const totalScore = totals.reduce((a, b) => a + b, 0);
    const avgScore = totals.length ? (totalScore / totals.length).toFixed(2) : "0.00";

    // Build print window
    const printWindow = window.open("", "_blank", "width=900,height=1000");
    printWindow.document.open();
    printWindow.document.write(`
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Student Result | Damotak International School</title>
<style>
  body {
    font-family: "Segoe UI", "Calibri", sans-serif;
    background: linear-gradient(135deg, #f7f9fc, #eef2f7);
    color: #2c3e50;
    margin: 30px;
    line-height: 1.6;
    position: relative;
  }

  /* Watermark */
  body::before {
    content: "";
    position: fixed;
    top: 50%;
    left: 50%;
    width: 750px;
    height: 750px;
    background: url('assets/images/auth/Damotak Logo.png') no-repeat center center;
    background-size: 60%;
    opacity: 0.05;
    transform: translate(-50%, -50%);
    z-index: -1;
  }

  .school-logo {
  border: 3px solid #0047AB; /* change color as you like */
  border-radius: 12px;        /* rounded corners, 0 for sharp edges */
  padding: 5px;               /* space between border and image */
  width: 150px;               /* adjust size */
  height: auto;               /* maintain aspect ratio */
  box-shadow: 0 4px 8px rgba(0,0,0,0.2); /* subtle shadow for sharp look */
  display: block;             /* center with margin if needed */
  margin: 20px auto;          /* centers image horizontally */
}

  .header {
    text-align: center;
    margin-bottom: 35px;
    position: relative;
  }
  .header img { width: 100px; margin-bottom: 10px; }
  .header h3 { margin: 5px 0; color: #1c3d72; text-transform: uppercase; letter-spacing: 1px; }
  .header p { margin: 2px 0; font-size: 13px; }

  .header::after {
    content: "";
    position: absolute;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 80%;
    height: 3px;
    background: linear-gradient(to right, #1c3d72, #2a4d69);
    border-radius: 5px;
  }
  
  .col h4,
.col ul {
  text-transform: uppercase; /* Make text uppercase */
}
 

  .row { display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 25px; }
  .col {
    flex: 1; min-width: 250px; background: #fff;
    border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.07);
    padding: 15px 20px;
  }
  .col h4 { margin-bottom: 8px; font-size: 14px; text-transform: uppercase; color: #fff; background: #1c3d72; padding: 5px 10px; border-radius: 5px 5px 0 0; }
  .col ul { list-style: none; padding: 10px 0 0 0; margin: 0; }
  .col ul li { margin: 4px 0; font-size: 13px; }
  .col ul li strong { color: #1c3d72; }

  table {
    width: 100%; border-collapse: collapse; margin-bottom: 25px;
    background: #fff; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
  }
  th {
    background: #1c3d72; color: #fff; padding: 6px; font-size: 13px; text-align: center;
  }
  td {
    text-align: center; padding: 6px; border-bottom: 1px solid #eef2f7; font-size: 13px;
  }
  tr:nth-child(even) td { background: #f9fbff; }
  .grade-tick { color: #1c3d72; font-size: 16px; }

  .section-title {
    font-weight: 700; margin: 25px 0 10px 0; font-size: 16px;
    color: #1c3d72; text-transform: uppercase; letter-spacing: 0.5px;
    border-left: 5px solid #1c3d72; padding-left: 10px;
  }

  .signatures { display: flex; justify-content: space-between; margin-top: 40px; }
  .sign {
    border-top: 2px solid #1c3d72; width: 45%; text-align: center;
    padding-top: 8px; font-size: 13px; color: #1c3d72; font-weight: 600;
  }

  @media print {
    body { background: #fff; -webkit-print-color-adjust: exact; }
    @page { size: A4; margin: 1cm; }
  }
    
  #resultTable td:nth-child(2),
  #resultTable th:nth-child(2),
  #resultTableBody input[name="subject"],
  #resultTableBody select[name="subject"] {
    text-transform: uppercase !important;
  }

</style>
</head>
<body>

<div class="header">
  <img src="assets/images/auth/Damotak Logo.png" alt="School Logo" class="school-logo">

  <h3>Damotak International School</h3>
  <p>ADDRESS 1: NEW OBA ROAD, ILE-IDANDE AREA, OKE-ONITEA</p>
  <p>ADDRESS 2: AYEKALE IYALODE ROAD, ILE-IDANDE AREA, OKE-ONITEA</p>
  <p>Email: DamotakInc@gmail.com | 08033880730</p>
  <p><strong>Academic Session:</strong> ${sessionYear}</p>
</div>

<div class="row">
  <div class="col">
    <h4>Student Details</h4>
    <ul>
      <li><strong>Name:</strong> ${studentName}</li>
      <li><strong>Gender:</strong> ${studentGender}</li>
      <li><strong>Class:</strong> ${studentClass}</li>
      <li><strong>Term:</strong> ${term}</li>
      <li><strong>Student ID:</strong> ${studentID}</li>
      <li><strong>Date Issued:</strong> ${dateIssued}</li>
    </ul>
  </div>
  <div class="col">
    <h4>Attendance & Physical Record</h4>
    <ul>
      <li><strong>Days Opened:</strong> ${daysOpened}</li>
      <li><strong>Days Present:</strong> ${daysPresent}</li>
      <li><strong>Days Absent:</strong> ${daysAbsent}</li>
      <li><strong>Height:</strong> ${studentHeight} cm</li>
      <li><strong>Weight:</strong> ${studentWeight} kg</li>
      <li><strong>Next Term Begins:</strong> ${nextTermDate}</li>
    </ul>
  </div>
</div>

<div class="section-title">Subjects and Scores</div>
${resultTable.outerHTML}

<div class="row">
  <div class="col">
    <h4>Summary</h4>
    <ul>
      <li><strong>Total Marks:</strong> ${totalScore}</li>
      <li><strong>Average Score:</strong> ${avgScore}%</li>
    </ul>
  </div>
  <div class="col">
    <h4>Remarks</h4>
    <ul>
      <li><strong>Class Teacher:</strong> ${classRemark}</li>
      <li><strong>Head Teacher:</strong> ${headRemark}</li>
    </ul>
  </div>
</div>

<!-- AFFECTIVE & PSYCHOMOTOR -->

<div class="section-title">Affective & Psychomotor Domain (A - E)</div>

<table>

<thead>

<tr>

<th>Area</th>

<th>A</th>

<th>B</th>

<th>C</th>

<th>D</th>

<th>E</th>

</tr>

</thead>

<tbody>

<tr>

<td>Neatness</td>

<td class="grade-tick">${Neatness=='A'?'‚úîÔ∏è':''}</td>

<td class="grade-tick">${Neatness=='B'?'‚úîÔ∏è':''}</td>

<td class="grade-tick">${Neatness=='C'?'‚úîÔ∏è':''}</td>

<td class="grade-tick">${Neatness=='D'?'‚úîÔ∏è':''}</td>

<td class="grade-tick">${Neatness=='E'?'‚úîÔ∏è':''}</td>

</tr>

<tr>

<td>Politeness</td>

<td class="grade-tick">${Politeness=='A'?'‚úîÔ∏è':''}</td>

<td class="grade-tick">${Politeness=='B'?'‚úîÔ∏è':''}</td>

<td class="grade-tick">${Politeness=='C'?'‚úîÔ∏è':''}</td>

<td class="grade-tick">${Politeness=='D'?'‚úîÔ∏è':''}</td>

<td class="grade-tick">${Politeness=='E'?'‚úîÔ∏è':''}</td>

</tr>

<tr>

<td>Punctuality</td>

<td class="grade-tick">${Punctuality=='A'?'‚úîÔ∏è':''}</td>

<td class="grade-tick">${Punctuality=='B'?'‚úîÔ∏è':''}</td>

<td class="grade-tick">${Punctuality=='C'?'‚úîÔ∏è':''}</td>

<td class="grade-tick">${Punctuality=='D'?'‚úîÔ∏è':''}</td>

<td class="grade-tick">${Punctuality=='E'?'‚úîÔ∏è':''}</td>

</tr>

<tr>

<td>Responsibility</td>

<td class="grade-tick">${Responsibility=='A'?'‚úîÔ∏è':''}</td>

<td class="grade-tick">${Responsibility=='B'?'‚úîÔ∏è':''}</td>

<td class="grade-tick">${Responsibility=='C'?'‚úîÔ∏è':''}</td>

<td class="grade-tick">${Responsibility=='D'?'‚úîÔ∏è':''}</td>

<td class="grade-tick">${Responsibility=='E'?'‚úîÔ∏è':''}</td>

</tr>

<tr>

<td>Teamwork</td>

<td class="grade-tick">${Teamwork=='A'?'‚úîÔ∏è':''}</td>

<td class="grade-tick">${Teamwork=='B'?'‚úîÔ∏è':''}</td>

<td class="grade-tick">${Teamwork=='C'?'‚úîÔ∏è':''}</td>

<td class="grade-tick">${Teamwork=='D'?'‚úîÔ∏è':''}</td>

<td class="grade-tick">${Teamwork=='E'?'‚úîÔ∏è':''}</td>

</tr>

<tr>

<td>Leadership</td>

<td class="grade-tick">${Leadership=='A'?'‚úîÔ∏è':''}</td>

<td class="grade-tick">${Leadership=='B'?'‚úîÔ∏è':''}</td>

<td class="grade-tick">${Leadership=='C'?'‚úîÔ∏è':''}</td>

<td class="grade-tick">${Leadership=='D'?'‚úîÔ∏è':''}</td>

<td class="grade-tick">${Leadership=='E'?'‚úîÔ∏è':''}</td>

</tr>

<tr>

<td>Helping Others</td>

<td class="grade-tick">${Helping=='A'?'‚úîÔ∏è':''}</td>

<td class="grade-tick">${Helping=='B'?'‚úîÔ∏è':''}</td>

<td class="grade-tick">${Helping=='C'?'‚úîÔ∏è':''}</td>

<td class="grade-tick">${Helping=='D'?'‚úîÔ∏è':''}</td>

<td class="grade-tick">${Helping=='E'?'‚úîÔ∏è':''}</td>

</tr>

</tbody>

</table>

<!-- ADDITIONAL GRADING TABLES -->

<div class="section-title">System Grading</div>

<table>

<thead>

<tr>

<th>Grade</th>

<th>Score Range</th>

<th>Description</th>

</tr>

</thead>

<tbody>

<tr><td>A</td><td>75-100</td><td>Excellent</td></tr>

<tr><td>B</td><td>60-74</td><td>Very Good</td></tr>

<tr><td>C</td><td>50-59</td><td>Good</td></tr>

<tr><td>D</td><td>40-49</td><td>Pass</td></tr>

<tr><td>E</td><td>0-39</td><td>Fail</td></tr>

</tbody>

</table>

<BR>

<BR>

<div class="signatures">
  <div class="sign">Class Teacher‚Äôs Signature</div>
  <div class="sign">Headmaster‚Äôs Signature</div>
</div>

</body>
</html>
    `);
    printWindow.document.close();

    // Print logic
    printWindow.onload = () => {
      const fileTitle = `${studentName.replace(/\s+/g, "_")}_${studentID}_Result`;
      printWindow.document.title = fileTitle;

      setTimeout(() => {
        printWindow.focus();
        printWindow.print();
      }, 2000);

      printWindow.onafterprint = printWindow.onbeforeunload = () => {
        printWindow.close();
        location.href = "result-add.html";
      };
    };

    setTimeout(() => {
      if (addSubjectBtn) addSubjectBtn.style.display = "inline-block";
    }, 3000);
  };
});




async function loadYearlySummary() {
  yearlySummaryBody.innerHTML = ""; // Clear old rows
  const terms = ["First Term", "Second Term", "Third Term"];
  const termResults = {};

  // Fetch results for each term
  for (let t of terms) {
    const snapshot = await get(ref(resultDb, `Results/${studentID}/${t}`));
    termResults[t] = snapshot.exists() ? snapshot.val().Subjects : {};
  }

  // Collect unique subjects (case-insensitive)
  const subjectSet = new Set();
  terms.forEach(term => {
    Object.keys(termResults[term] || {}).forEach(sub => {
      subjectSet.add(sub.trim().toLowerCase());
    });
  });
  const allSubjects = Array.from(subjectSet);

  // Populate table: one row per subject
  allSubjects.forEach((subjectKey, index) => {
    // Find original subject names for display
    const firstTermSub = Object.keys(termResults["First Term"] || {}).find(s => s.trim().toLowerCase() === subjectKey) || "";
    const secondTermSub = Object.keys(termResults["Second Term"] || {}).find(s => s.trim().toLowerCase() === subjectKey) || "";
    const thirdTermSub = Object.keys(termResults["Third Term"] || {}).find(s => s.trim().toLowerCase() === subjectKey) || "";

    const firstTerm = termResults["First Term"][firstTermSub]?.total || 0;
    const secondTerm = termResults["Second Term"][secondTermSub]?.total || 0;
    const thirdTerm = termResults["Third Term"][thirdTermSub]?.total || 0;

    const avgTotal = ((firstTerm + secondTerm + thirdTerm) / 3).toFixed(2);

    // Assign grade & remark
    let grade, remark;
    if (avgTotal >= 70) {
      grade = "A";
      remark = "Excellent";
    } else if (avgTotal >= 60) {
      grade = "B";
      remark = "Very Good";
    } else if (avgTotal >= 50) {
      grade = "C";
      remark = "Good";
    } else if (avgTotal >= 40) {
      grade = "D";
      remark = "Fair";
    } else {
      grade = "F";
      remark = "Fail";
    }

    // Create and append table row
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${index + 1}</td>
      <td>${firstTermSub || secondTermSub || thirdTermSub || subjectKey}</td>
      <td>${firstTerm}</td>
      <td>${secondTerm}</td>
      <td>${thirdTerm}</td>
      <td>${avgTotal}</td>
      <td>${grade}</td>
      <td>${remark}</td>
    `;
    yearlySummaryBody.appendChild(row);
  });

  // Show "No previous result found" if empty
  if (allSubjects.length === 0) {
    yearlySummaryBody.innerHTML = `
      <tr>
        <td colspan="8" style="text-align:center; color:#d9534f; font-weight:bold;">
          ‚ÑπÔ∏è No previous result found.
        </td>
      </tr>
    `;
  }
}


// ---------------------------
// Navigation Buttons
// ---------------------------
document.getElementById("backBtn").addEventListener("click", () => window.location.href = "result-list.html");

// ---------------------------
// Automatic promotion: Initialize next class
// ---------------------------
if(promotionStatus.includes("Promoted")){
    const nextClass = getNextClass(studentClass);

    // Create empty terms for next class
    await set(ref(resultDb, `Results/${studentID}/${nextClass}/First Term/Subjects`), {});
    await set(ref(resultDb, `Results/${studentID}/${nextClass}/Second Term/Subjects`), {});
    await set(ref(resultDb, `Results/${studentID}/${nextClass}/Third Term/Subjects`), {});
    await set(ref(resultDb, `Results/${studentID}/${nextClass}/Yearly Summary`), {});
}

// ---------------------------
// Helper: Get Next Class
// ---------------------------
function getNextClass(currentClass){
    const classes = [
        "Creche",
        "Nursery 1",
        "Nursery 2",
        "Primary 1",
        "Primary 2",
        "Primary 3",
        "Primary 4",
        "Primary 5",
        "JSS 1",
        "JSS 2",
        "JSS 3",
        "SSS 1",
        "SSS 2",
        "SSS 3"
    ];

    const index = classes.indexOf(currentClass);

    if(index >= 0 && index < classes.length-1){
        return classes[index + 1]; // next class
    } else if(index === classes.length-1){
        return "Graduate"; // after SSS 3
    } else {
        return currentClass; // fallback in case class not found
    }
}

// result-add.js
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, ref, get, set, update } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";
import { saveResult } from "./result-save.js";

// ---------------------------
// Firebase Configs
// ---------------------------
const studentFirebaseConfig = {
  apiKey: "AIzaSyCz8GoyOi7wviejSPG2CGkOYvEwsaAWX0w",
  authDomain: "damotak-students-database.firebaseapp.com",
  databaseURL: "https://damotak-students-database-default-rtdb.firebaseio.com/",
  projectId: "damotak-students-database",
  storageBucket: "damotak-students-database.firebasestorage.app",
  messagingSenderId: "806502646085",
  appId: "1:806502646085:web:36a97f1d1e0ff4bab6be2c"
};

const resultFirebaseConfig = {
  apiKey: "AIzaSyDcrh8wVfeVwnOKnt-AcWDMOmxqNWe_0Uw",
  authDomain: "damotak-result-database.firebaseapp.com",
  databaseURL: "https://damotak-result-database-default-rtdb.firebaseio.com/",
  projectId: "damotak-result-database",
  storageBucket: "damotak-result-database.firebasestorage.app",
  messagingSenderId: "413754960869",
  appId: "1:413754960869:web:b3f51b6aaa0c667af0dd0c"
};

// ---------------------------
// Initialize Firebase Apps
// ---------------------------
const studentApp = initializeApp(studentFirebaseConfig, "studentDB");
const studentDb = getDatabase(studentApp);

const resultApp = initializeApp(resultFirebaseConfig, "resultDB");
const resultDb = getDatabase(resultApp);

// ---------------------------
// Page Setup
// ---------------------------
const urlParams = new URLSearchParams(window.location.search);
const studentID = urlParams.get("id");
document.getElementById("dateIssued").textContent = new Date().toLocaleDateString();

const tbody = document.getElementById("resultTableBody");

// ---------------------------
// Notification Helper (Updated)
// ---------------------------
function showNotification(message, success) {
  const msgDiv = document.getElementById("notificationMessage");
  if (!msgDiv) return alert(message);

  msgDiv.textContent = message;
  msgDiv.style.color = success ? "green" : "red";

  const modalEl = document.getElementById("notificationModal");
  let modal = bootstrap.Modal.getInstance(modalEl);

  if (!modal) modal = new bootstrap.Modal(modalEl);

  modal.show();

  // Remove lingering backdrop when modal closes
  modalEl.addEventListener('hidden.bs.modal', () => {
    document.body.classList.remove('modal-open');
    const backdrop = document.querySelector('.modal-backdrop');
    if (backdrop) backdrop.remove();
  }, { once: true }); // ensure this runs only once per show
}

// ---------------------------
// Term Change Logic (Updated)
// ---------------------------
document.getElementById("studentTerm").addEventListener("change", async (e) => {
    const term = e.target.value;

    // Hide sections for attendance and remarks
    const attendanceDetailsContainer = document.querySelector('.p-3.mt-4.border-top'); // Attendance details
    const remarksContainer = document.querySelectorAll('.p-3.mt-4.border-top')[1]; // Remarks section

    if (term === "Yearly Summary") {
        yearlySummaryContainer.style.display = "block"; // Show yearly summary
        document.getElementById("resultTable").parentElement.style.display = "none"; // Hide term table
        await loadYearlySummary(); // Load yearly summary
        document.getElementById("printButton").style.display = "block"; // Show print button
        document.getElementById("addRow").style.display = "none"; // Hide add row button
        attendanceDetailsContainer.style.display = "none"; // Hide attendance details
        remarksContainer.style.display = "none"; // Hide remarks
    } else {
        yearlySummaryContainer.style.display = "none"; // Hide yearly summary
        document.getElementById("printButton").style.display = "none"; // Hide print button
        document.getElementById("addRow").style.display = "block"; // Show add row button
        document.getElementById("resultTable").parentElement.style.display = "block"; // Show term table
        await loadPreviousResults(term); // Load selected term
        attendanceDetailsContainer.style.display = "block"; // Show attendance details
        remarksContainer.style.display = "block"; // Show remarks
    }
});
// ---------------------------
// Load Student Info
// ---------------------------
async function loadStudent() {
  try {
    const snap = await get(ref(studentDb, `Students/${studentID}`));
    if (snap.exists()) {
      const data = snap.val();
      document.getElementById("studentName").textContent = data.name || "N/A";
      document.getElementById("studentClass").textContent = data.studentClass || "N/A";
      document.getElementById("studentGender").textContent = data.gender || "N/A";
    } else {
      showNotification("‚ùå Student not found!", false);
    }
  } catch (err) {
    showNotification("‚ö†Ô∏è Error loading student info: " + err.message, false);
  }
}
loadStudent();

// ---------------------------
// Table Functions
// ---------------------------
function addSubjectRow(subject = "", ca = "", exam = "", total = "0", grade = "-", remark = "-", readOnly = false) {
  const row = document.createElement("tr");
  row.innerHTML = `
   <td class="sl">${tbody.children.length + 1}</td>
   <td><input type="text" class="form-control subject-input" value="${subject}" ${readOnly ? "readonly" : ""}></td>
   <td><input type="number" class="form-control mark-ca" value="30" readonly></td>
   <td><input type="number" class="form-control ca-input" value="${ca}" min="0" max="30" ${readOnly ? "readonly" : ""}></td>
   <td><input type="number" class="form-control mark-exam" value="70" readonly></td>
   <td><input type="number" class="form-control exam-input" value="${exam}" min="0" max="70" ${readOnly ? "readonly" : ""}></td>
   <td class="total-score">${total}</td>
   <td class="grade">${grade}</td>
   <td class="remark">${remark}</td>
   <td class="text-center">${readOnly ? "" : '<button class="btn btn-danger btn-sm remove-row">‚úï</button>'}</td>
  `;
  tbody.appendChild(row);
  refreshRowNumbers();
}

function refreshRowNumbers() {
  Array.from(tbody.children).forEach((tr, i) => tr.querySelector(".sl").textContent = i + 1);
}

// ---------------------------
// Add / Remove Rows
// ---------------------------
document.getElementById("addRow").addEventListener("click", () => addSubjectRow());
tbody.addEventListener("click", (e) => {
  if (e.target.classList.contains("remove-row")) {
    e.target.closest("tr").remove();
    refreshRowNumbers();
  }
});

// ---------------------------
// Auto Calculate Grades
// ---------------------------
tbody.addEventListener("input", (e) => {
  if (e.target.classList.contains("ca-input") || e.target.classList.contains("exam-input")) {
    const tr = e.target.closest("tr");
    const ca = parseInt(tr.querySelector(".ca-input").value) || 0;
    const exam = parseInt(tr.querySelector(".exam-input").value) || 0;
    const total = ca + exam;
    let grade = "-", remark = "-";

    if (total >= 70) { grade = "A"; remark = "Excellent"; }
    else if (total >= 60) { grade = "B"; remark = "Very Good"; }
    else if (total >= 50) { grade = "C"; remark = "Good"; }
    else if (total >= 40) { grade = "D"; remark = "Fair"; }
    else { grade = "F"; remark = "Fail"; }

    tr.querySelector(".total-score").textContent = total;
    tr.querySelector(".grade").textContent = grade;
    tr.querySelector(".remark").textContent = remark;
  }
});

// ---------------------------
// Grade & Score Validation
// ---------------------------
tbody.addEventListener("input", (e) => {
  const target = e.target;
  const row = target.closest("tr");
  const caInput = row.querySelector(".ca-input");
  const examInput = row.querySelector(".exam-input");
  const totalCell = row.querySelector(".total-score");

  // CA Input Validation
  if (target.classList.contains("ca-input")) {
    let val = parseInt(caInput.value) || 0;
    if (val < 0) val = 0;
    if (val > 30) {
      alert("‚ùå CA cannot be more than 30. Resetting to 0.");
      caInput.value = 0;
      examInput.value = 0;
      totalCell.textContent = 0;
      row.querySelector(".grade").textContent = "-";
      row.querySelector(".remark").textContent = "-";
      return;
    }
    caInput.value = val;
    totalCell.textContent = val + (parseInt(examInput.value) || 0);
  }

  // Exam Input Validation
  if (target.classList.contains("exam-input")) {
    let val = parseInt(examInput.value) || 0;
    if (val < 0) val = 0;
    if (val > 70) {
      alert("‚ùå Exam cannot be more than 70. Resetting to 0.");
      examInput.value = 0;
      caInput.value = 0;
      totalCell.textContent = 0;
      row.querySelector(".grade").textContent = "-";
      row.querySelector(".remark").textContent = "-";
      return;
    }
    examInput.value = val;
    totalCell.textContent = val + (parseInt(caInput.value) || 0);
  }
});

// ---------------------------
// Prevent Saving if Invalid Grade
// ---------------------------
document.getElementById("saveResult").addEventListener("click", () => {
  let invalidGrade = false;
  tbody.querySelectorAll(".grade-input").forEach(input => {
    const val = input.value.toUpperCase();
    if (val && !["A","B","C","D","E"].includes(val)) invalidGrade = true;
  });

  if (invalidGrade) {
    return alert("‚ùå Cannot save. Some grade inputs are invalid! Only A, B, C, D, E are allowed.");
  }

  // ... your save logic here ...
});

// ---------------------------
// Attendance Input Validation
// ---------------------------
const attendanceInputs = ["daysOpened", "daysPresent", "daysAbsent", "studentHeight", "studentWeight"];
attendanceInputs.forEach(id => {
  const input = document.getElementById(id);

  input.addEventListener("input", (e) => {
    let val = e.target.value.replace(/\D/g, ""); // remove non-digit chars
    if (val.length > 3) val = val.slice(0, 3);   // max 3 digits
    e.target.value = val;
  });

  input.addEventListener("blur", (e) => {
    if (e.target.value !== "") e.target.value = parseInt(e.target.value, 10);
  });
});

// Attendance calculation: Days Opened = Present + Absent
const daysOpenedInput = document.getElementById("daysOpened");
const daysPresentInput = document.getElementById("daysPresent");
const daysAbsentInput = document.getElementById("daysAbsent");

function validateAttendance() {
  const opened = parseInt(daysOpenedInput.value) || 0;
  const present = parseInt(daysPresentInput.value) || 0;
  const absent = parseInt(daysAbsentInput.value) || 0;

  if (opened !== (present + absent)) {
    daysOpenedInput.setCustomValidity("Days Opened must equal Days Present + Days Absent");
    daysOpenedInput.reportValidity();
  } else {
    daysOpenedInput.setCustomValidity("");
  }
}

[daysOpenedInput, daysPresentInput, daysAbsentInput].forEach(input => {
  input.addEventListener("input", validateAttendance);
});

// ---------------------------
// Affective & Psychomotor Domain Validation
// ---------------------------
const remarkFields = [
  "Neatness", "Politeness", "Punctuality", "Responsibility",
  "Teamwork", "Leadership", "Helping", "Honesty", "Participation"
];

remarkFields.forEach(id => {
  const textarea = document.getElementById(id);
  textarea.addEventListener("input", (e) => {
    let val = e.target.value.toUpperCase();
    if (val.length > 1 || !["A", "B", "C", "D", "E"].includes(val)) {
      alert(`‚ùå Invalid input for ${id}! Only a single character A, B, C, D, or E is allowed.`);
      e.target.value = "";
    } else {
      e.target.value = val;
    }
  });
});


// ---------------------------
// Load Previous Results
// ---------------------------
async function loadPreviousResults() {
  const term = document.getElementById("studentTerm")?.value?.trim();
  if (!term || !studentID) return;

  try {
    const snapshot = await get(ref(resultDb, `Results/${studentID}/${term}`));
    tbody.innerHTML = "";

    if (snapshot.exists()) {
      const data = snapshot.val();
      const subjects = data.Subjects || {};
      Object.keys(subjects).forEach(sub => {
        const s = subjects[sub];
        addSubjectRow(s.subject || sub, s.ca || 0, s.exam || 0, s.total || 0, s.grade || "-", s.remark || "-", true);
      });

      document.getElementById("classTeacherRemark").value = data.classTeacherRemark || "";
      document.getElementById("headTeacherRemark").value = data.headTeacherRemark || "";
       document.getElementById("Neatness").value = data.Neatness || "";
        document.getElementById("Politeness").value = data.Politeness || "";
        document.getElementById("Punctuality").value = data.Punctuality || "";
         document.getElementById("Responsibility").value = data.Responsibility || "";
          document.getElementById("Teamwork").value = data.Teamwork || "";
           document.getElementById("Leadership").value = data.Leadership || "";
            document.getElementById("Helping").value = data.Helping || "";
             document.getElementById("Honesty").value = data.Honesty || "";
               document.getElementById("Participation").value = data.Participation || "";
                document.getElementById("daysOpened").value = data.daysOpened || "";
                 document.getElementById("daysPresent").value = data.daysPresent || "";
                  document.getElementById("daysAbsent").value = data.daysAbsent || "";
                   document.getElementById("studentHeight").value = data.studentHeight || "";
                    document.getElementById("studentWeight").value = data.studentWeight || "";
                     document.getElementById("nextTermDate").value = data.nextTermDate || "";
        
      showNotification("‚úÖ Loaded previous results!", true);
    } else {
      addSubjectRow();
      showNotification("‚ÑπÔ∏è No previous result found.", false);
    }
  } catch (err) {
    console.error(err);
    showNotification("‚ö†Ô∏è Failed to load results: " + err.message, false);
  }
}

document.getElementById("studentTerm").addEventListener("change", loadPreviousResults);
window.addEventListener("load", () => setTimeout(loadPreviousResults, 200));

// ---------------------------
// Save Result
// ---------------------------
document.getElementById("saveResult").addEventListener("click", async () => {
  const term = document.getElementById("studentTerm").value.trim();
  const classTeacherRemark = document.getElementById("classTeacherRemark").value.trim();
  const headTeacherRemark = document.getElementById("headTeacherRemark").value.trim();
  const Neatness = document.getElementById("Neatness").value.trim();
  const Politeness = document.getElementById("Politeness").value.trim();
  const Punctuality = document.getElementById("Punctuality").value.trim();
   const Responsibility = document.getElementById("Responsibility").value.trim();
    const Teamwork = document.getElementById("Teamwork").value.trim();
     const Leadership = document.getElementById("Leadership").value.trim();
      const Helping = document.getElementById("Helping").value.trim();
       const Honesty = document.getElementById("Honesty").value.trim();
        const Participation = document.getElementById("Participation").value.trim();
        const daysOpened = document.getElementById("daysOpened").value.trim();
        const daysPresent = document.getElementById("daysPresent").value.trim();
        const daysAbsent = document.getElementById("daysAbsent").value.trim();
        const studentHeight = document.getElementById("studentHeight").value.trim();
        const studentWeight = document.getElementById("studentWeight").value.trim();
         const nextTermDate = document.getElementById("nextTermDate").value.trim();
        


  const subjects = [];
  tbody.querySelectorAll("tr").forEach(tr => {
    const subject = tr.querySelector(".subject-input").value.trim();
    const ca = parseInt(tr.querySelector(".ca-input").value) || 0;
    const exam = parseInt(tr.querySelector(".exam-input").value) || 0;
    const total = ca + exam;
    const grade = tr.querySelector(".grade").textContent || "-";
    const remark = tr.querySelector(".remark").textContent || "-";
    if (subject && !tr.querySelector(".subject-input").readOnly) {
      subjects.push({ subject, ca, exam, total, grade, remark });
    }
  });

  if (!subjects.length && !classTeacherRemark.length) {
    return showNotification("‚ö†Ô∏è Add at least one new subject or comment before saving.", false);
  }
  
 

  const resultData = {
    studentID,
    term,
    classTeacherRemark,
    headTeacherRemark,
    Neatness,
    Politeness,
    Punctuality,
    Responsibility,
    Teamwork,
    Leadership,
    Helping,
    Honesty,
    Participation,
    daysOpened,
    daysPresent,
    daysAbsent,
    studentHeight,
    studentWeight,
    nextTermDate,
    dateIssued: new Date().toLocaleDateString(),
    subjects
  };

  const res = await saveResult(studentID, term, resultData);
  showNotification(res.message, res.success);
  if (res.success) setTimeout(loadPreviousResults, 400);
});

// ---------------------------
// Print Result Function (Auto Print After 2s + Dynamic File Name)
// ---------------------------
document.getElementById("PrintResult").addEventListener("click", () => {
  const modal = new bootstrap.Modal(document.getElementById("printConfirmModal"));
  modal.show();

  document.getElementById("confirmPrintBtn").onclick = () => {
    modal.hide();

    // Hide "Add New Subject" button temporarily
    const addSubjectBtn = document.getElementById("addRow");
    if (addSubjectBtn) addSubjectBtn.style.display = "none";

    // Clone and clean result table
    const resultTable = document.getElementById("resultTable").cloneNode(true);

    // Remove "Action" column
    const headerRow = resultTable.querySelector("thead tr");
    if (headerRow && headerRow.lastElementChild.textContent.trim().toLowerCase() === "action") {
      headerRow.removeChild(headerRow.lastElementChild);
    }

    // Remove "Action" cells in body
    resultTable.querySelectorAll("tbody tr").forEach(row => {
      if (row.lastElementChild) row.removeChild(row.lastElementChild);
    });

    // Convert inputs to plain text
    resultTable.querySelectorAll("input, select").forEach(el => {
      const td = el.parentElement;
      td.textContent = el.value || "-";
    });

    // Get student info
    const studentName = document.getElementById("studentName").textContent.trim();
    const studentGender = document.getElementById("studentGender").textContent.trim();
    const studentClass = document.getElementById("studentClass").textContent.trim();
    const term = document.getElementById("studentTerm").value || document.getElementById("studentTerm").textContent.trim();
    const dateIssued = document.getElementById("dateIssued").textContent.trim();
    const sessionYear = document.getElementById("sessionYear")?.textContent.trim() || "2025/2026";
    const classRemark = document.getElementById("classTeacherRemark").value || "-";
    const headRemark = document.getElementById("headTeacherRemark").value || "-";
    const Neatness = document.getElementById("Neatness")?.value || "-";
    const Politeness = document.getElementById("Politeness")?.value || "-";
    const Punctuality = document.getElementById("Punctuality")?.value || "-";
    const Responsibility = document.getElementById("Responsibility")?.value || "-";
    const Leadership = document.getElementById("Leadership")?.value || "-";
    const Helping = document.getElementById("Helping")?.value || "-";
    const Honesty = document.getElementById("Honesty")?.value || "-";
    const Teamwork = document.getElementById("Teamwork")?.value || "-";
    const daysOpened = document.getElementById("daysOpened")?.value || "-";
    const daysPresent = document.getElementById("daysPresent")?.value || "-";
    const daysAbsent = document.getElementById("daysAbsent")?.value || "-";
    const studentHeight = document.getElementById("studentHeight")?.value || "-";
    const studentWeight = document.getElementById("studentWeight")?.value || "-";
    const nextTermDate = document.getElementById("nextTermDate")?.value || "-";

    // Calculate total and average
    const totals = Array.from(resultTable.querySelectorAll(".total-score")).map(td => parseInt(td.textContent) || 0);
    const totalScore = totals.reduce((a, b) => a + b, 0);
    const avgScore = totals.length ? (totalScore / totals.length).toFixed(2) : "0.00";

    // Build print window
    const printWindow = window.open("", "_blank", "width=900,height=1000");
    printWindow.document.open();
    printWindow.document.write(`
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Student Result | Damotak International School</title>
<style>
  body {
    font-family: "Segoe UI", "Calibri", sans-serif;
    background: linear-gradient(135deg, #f7f9fc, #eef2f7);
    color: #2c3e50;
    margin: 30px;
    line-height: 1.6;
    position: relative;
  }

  /* Watermark */
  body::before {
    content: "";
    position: fixed;
    top: 50%;
    left: 50%;
    width: 750px;
    height: 750px;
    background: url('assets/images/auth/Damotak Logo.png') no-repeat center center;
    background-size: 60%;
    opacity: 0.05;
    transform: translate(-50%, -50%);
    z-index: -1;
  }

  .school-logo {
  border: 3px solid #0047AB; /* change color as you like */
  border-radius: 12px;        /* rounded corners, 0 for sharp edges */
  padding: 5px;               /* space between border and image */
  width: 150px;               /* adjust size */
  height: auto;               /* maintain aspect ratio */
  box-shadow: 0 4px 8px rgba(0,0,0,0.2); /* subtle shadow for sharp look */
  display: block;             /* center with margin if needed */
  margin: 20px auto;          /* centers image horizontally */
}

  .header {
    text-align: center;
    margin-bottom: 35px;
    position: relative;
  }
  .header img { width: 100px; margin-bottom: 10px; }
  .header h3 { margin: 5px 0; color: #1c3d72; text-transform: uppercase; letter-spacing: 1px; }
  .header p { margin: 2px 0; font-size: 13px; }

  .header::after {
    content: "";
    position: absolute;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 80%;
    height: 3px;
    background: linear-gradient(to right, #1c3d72, #2a4d69);
    border-radius: 5px;
  }
  
  .col h4,
.col ul {
  text-transform: uppercase; /* Make text uppercase */
}
 

  .row { display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 25px; }
  .col {
    flex: 1; min-width: 250px; background: #fff;
    border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.07);
    padding: 15px 20px;
  }
  .col h4 { margin-bottom: 8px; font-size: 14px; text-transform: uppercase; color: #fff; background: #1c3d72; padding: 5px 10px; border-radius: 5px 5px 0 0; }
  .col ul { list-style: none; padding: 10px 0 0 0; margin: 0; }
  .col ul li { margin: 4px 0; font-size: 13px; }
  .col ul li strong { color: #1c3d72; }

  table {
    width: 100%; border-collapse: collapse; margin-bottom: 25px;
    background: #fff; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
  }
  th {
    background: #1c3d72; color: #fff; padding: 6px; font-size: 13px; text-align: center;
  }
  td {
    text-align: center; padding: 6px; border-bottom: 1px solid #eef2f7; font-size: 13px;
  }
  tr:nth-child(even) td { background: #f9fbff; }
  .grade-tick { color: #1c3d72; font-size: 16px; }

  .section-title {
    font-weight: 700; margin: 25px 0 10px 0; font-size: 16px;
    color: #1c3d72; text-transform: uppercase; letter-spacing: 0.5px;
    border-left: 5px solid #1c3d72; padding-left: 10px;
  }

  .signatures { display: flex; justify-content: space-between; margin-top: 40px; }
  .sign {
    border-top: 2px solid #1c3d72; width: 45%; text-align: center;
    padding-top: 8px; font-size: 13px; color: #1c3d72; font-weight: 600;
  }

  @media print {
    body { background: #fff; -webkit-print-color-adjust: exact; }
    @page { size: A4; margin: 1cm; }
  }
    
  #resultTable td:nth-child(2),
  #resultTable th:nth-child(2),
  #resultTableBody input[name="subject"],
  #resultTableBody select[name="subject"] {
    text-transform: uppercase !important;
  }

</style>
</head>
<body>

<div class="header">
  <img src="assets/images/auth/Damotak Logo.png" alt="School Logo" class="school-logo">

  <h3>Damotak International School</h3>
  <p>ADDRESS 1: NEW OBA ROAD, ILE-IDANDE AREA, OKE-ONITEA</p>
  <p>ADDRESS 2: AYEKALE IYALODE ROAD, ILE-IDANDE AREA, OKE-ONITEA</p>
  <p>Email: DamotakInc@gmail.com | 08033880730</p>
  <p><strong>Academic Session:</strong> ${sessionYear}</p>
</div>

<div class="row">
  <div class="col">
    <h4>Student Details</h4>
    <ul>
      <li><strong>Name:</strong> ${studentName}</li>
      <li><strong>Gender:</strong> ${studentGender}</li>
      <li><strong>Class:</strong> ${studentClass}</li>
      <li><strong>Term:</strong> ${term}</li>
      <li><strong>Student ID:</strong> ${studentID}</li>
      <li><strong>Date Issued:</strong> ${dateIssued}</li>
    </ul>
  </div>
  <div class="col">
    <h4>Attendance & Physical Record</h4>
    <ul>
      <li><strong>Days Opened:</strong> ${daysOpened}</li>
      <li><strong>Days Present:</strong> ${daysPresent}</li>
      <li><strong>Days Absent:</strong> ${daysAbsent}</li>
      <li><strong>Height:</strong> ${studentHeight} cm</li>
      <li><strong>Weight:</strong> ${studentWeight} kg</li>
      <li><strong>Next Term Begins:</strong> ${nextTermDate}</li>
    </ul>
  </div>
</div>

<div class="section-title">Subjects and Scores</div>
${resultTable.outerHTML}

<div class="row">
  <div class="col">
    <h4>Summary</h4>
    <ul>
      <li><strong>Total Marks:</strong> ${totalScore}</li>
      <li><strong>Average Score:</strong> ${avgScore}%</li>
    </ul>
  </div>
  <div class="col">
    <h4>Remarks</h4>
    <ul>
      <li><strong>Class Teacher:</strong> ${classRemark}</li>
      <li><strong>Head Teacher:</strong> ${headRemark}</li>
    </ul>
  </div>
</div>

<!-- AFFECTIVE & PSYCHOMOTOR -->

<div class="section-title">Affective & Psychomotor Domain (A - E)</div>

<table>

<thead>

<tr>

<th>Area</th>

<th>A</th>

<th>B</th>

<th>C</th>

<th>D</th>

<th>E</th>

</tr>

</thead>

<tbody>

<tr>

<td>Neatness</td>

<td class="grade-tick">${Neatness=='A'?'‚úîÔ∏è':''}</td>

<td class="grade-tick">${Neatness=='B'?'‚úîÔ∏è':''}</td>

<td class="grade-tick">${Neatness=='C'?'‚úîÔ∏è':''}</td>

<td class="grade-tick">${Neatness=='D'?'‚úîÔ∏è':''}</td>

<td class="grade-tick">${Neatness=='E'?'‚úîÔ∏è':''}</td>

</tr>

<tr>

<td>Politeness</td>

<td class="grade-tick">${Politeness=='A'?'‚úîÔ∏è':''}</td>

<td class="grade-tick">${Politeness=='B'?'‚úîÔ∏è':''}</td>

<td class="grade-tick">${Politeness=='C'?'‚úîÔ∏è':''}</td>

<td class="grade-tick">${Politeness=='D'?'‚úîÔ∏è':''}</td>

<td class="grade-tick">${Politeness=='E'?'‚úîÔ∏è':''}</td>

</tr>

<tr>

<td>Punctuality</td>

<td class="grade-tick">${Punctuality=='A'?'‚úîÔ∏è':''}</td>

<td class="grade-tick">${Punctuality=='B'?'‚úîÔ∏è':''}</td>

<td class="grade-tick">${Punctuality=='C'?'‚úîÔ∏è':''}</td>

<td class="grade-tick">${Punctuality=='D'?'‚úîÔ∏è':''}</td>

<td class="grade-tick">${Punctuality=='E'?'‚úîÔ∏è':''}</td>

</tr>

<tr>

<td>Responsibility</td>

<td class="grade-tick">${Responsibility=='A'?'‚úîÔ∏è':''}</td>

<td class="grade-tick">${Responsibility=='B'?'‚úîÔ∏è':''}</td>

<td class="grade-tick">${Responsibility=='C'?'‚úîÔ∏è':''}</td>

<td class="grade-tick">${Responsibility=='D'?'‚úîÔ∏è':''}</td>

<td class="grade-tick">${Responsibility=='E'?'‚úîÔ∏è':''}</td>

</tr>

<tr>

<td>Teamwork</td>

<td class="grade-tick">${Teamwork=='A'?'‚úîÔ∏è':''}</td>

<td class="grade-tick">${Teamwork=='B'?'‚úîÔ∏è':''}</td>

<td class="grade-tick">${Teamwork=='C'?'‚úîÔ∏è':''}</td>

<td class="grade-tick">${Teamwork=='D'?'‚úîÔ∏è':''}</td>

<td class="grade-tick">${Teamwork=='E'?'‚úîÔ∏è':''}</td>

</tr>

<tr>

<td>Leadership</td>

<td class="grade-tick">${Leadership=='A'?'‚úîÔ∏è':''}</td>

<td class="grade-tick">${Leadership=='B'?'‚úîÔ∏è':''}</td>

<td class="grade-tick">${Leadership=='C'?'‚úîÔ∏è':''}</td>

<td class="grade-tick">${Leadership=='D'?'‚úîÔ∏è':''}</td>

<td class="grade-tick">${Leadership=='E'?'‚úîÔ∏è':''}</td>

</tr>

<tr>

<td>Helping Others</td>

<td class="grade-tick">${Helping=='A'?'‚úîÔ∏è':''}</td>

<td class="grade-tick">${Helping=='B'?'‚úîÔ∏è':''}</td>

<td class="grade-tick">${Helping=='C'?'‚úîÔ∏è':''}</td>

<td class="grade-tick">${Helping=='D'?'‚úîÔ∏è':''}</td>

<td class="grade-tick">${Helping=='E'?'‚úîÔ∏è':''}</td>

</tr>

</tbody>

</table>

<!-- ADDITIONAL GRADING TABLES -->

<div class="section-title">System Grading</div>

<table>

<thead>

<tr>

<th>Grade</th>

<th>Score Range</th>

<th>Description</th>

</tr>

</thead>

<tbody>

<tr><td>A</td><td>75-100</td><td>Excellent</td></tr>

<tr><td>B</td><td>60-74</td><td>Very Good</td></tr>

<tr><td>C</td><td>50-59</td><td>Good</td></tr>

<tr><td>D</td><td>40-49</td><td>Pass</td></tr>

<tr><td>E</td><td>0-39</td><td>Fail</td></tr>

</tbody>

</table>

<BR>

<BR>

<div class="signatures">
  <div class="sign">Class Teacher‚Äôs Signature</div>
  <div class="sign">Headmaster‚Äôs Signature</div>
</div>

</body>
</html>
    `);
    printWindow.document.close();

    // Print logic
    printWindow.onload = () => {
      const fileTitle = `${studentName.replace(/\s+/g, "_")}_${studentID}_Result`;
      printWindow.document.title = fileTitle;

      setTimeout(() => {
        printWindow.focus();
        printWindow.print();
      }, 2000);

      printWindow.onafterprint = printWindow.onbeforeunload = () => {
        printWindow.close();
        location.href = "result-add.html";
      };
    };

    setTimeout(() => {
      if (addSubjectBtn) addSubjectBtn.style.display = "inline-block";
    }, 3000);
  };
});

// ---------------------------
// Global Variables
// ---------------------------
let studentName = "";
let studentGender = "";
let studentClass = "";
let sessionYear = "";
let term = "Yearly Summary";
let avgScore = 0;
let totalScoreValue = 0;
let promotionStatus = "";

// ---------------------------
// Print Result Function
// ---------------------------
document.getElementById("printButton").addEventListener("click", () => {
   // Ensure all student info is populated
    studentName = document.getElementById("studentName")?.value || document.getElementById("studentName")?.textContent || "-";
    studentGender = document.getElementById("studentGender")?.value || document.getElementById("studentGender")?.textContent || "-";
    studentClass = document.getElementById("studentClass")?.value || document.getElementById("studentClass")?.textContent || "-";
    sessionYear = document.getElementById("sessionYear")?.value || document.getElementById("sessionYear")?.textContent || "-";
    promotionStatus = document.getElementById("promotionStatus")?.value || "-";
    
    const resultTable = document.getElementById("yearlySummaryTable").cloneNode(true);

    const printWindow = window.open("", "_blank", "width=900,height=1000");
    printWindow.document.open();
    printWindow.document.write(`
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Student Result | Damotak International School</title>
   <style>
  body {
    font-family: "Segoe UI", "Calibri", sans-serif;
    background: linear-gradient(135deg, #f7f9fc, #eef2f7);
    color: #2c3e50;
    margin: 30px;
    line-height: 1.6;
    position: relative;
  }

  /* Watermark */
  body::before {
    content: "";
    position: fixed;
    top: 50%;
    left: 50%;
    width: 750px;
    height: 750px;
    background: url('assets/images/auth/Damotak Logo.png') no-repeat center center;
    background-size: 60%;
    opacity: 0.05;
    transform: translate(-50%, -50%);
    z-index: -1;
  }

  .school-logo {
  border: 3px solid #0047AB; /* change color as you like */
  border-radius: 12px;        /* rounded corners, 0 for sharp edges */
  padding: 5px;               /* space between border and image */
  width: 150px;               /* adjust size */
  height: auto;               /* maintain aspect ratio */
  box-shadow: 0 4px 8px rgba(0,0,0,0.2); /* subtle shadow for sharp look */
  display: block;             /* center with margin if needed */
  margin: 20px auto;          /* centers image horizontally */
}

  .header {
    text-align: center;
    margin-bottom: 35px;
    position: relative;
  }
  .header img { width: 100px; margin-bottom: 10px; }
  .header h3 { margin: 5px 0; color: #1c3d72; text-transform: uppercase; letter-spacing: 1px; }
  .header p { margin: 2px 0; font-size: 13px; }

  .header::after {
    content: "";
    position: absolute;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 80%;
    height: 3px;
    background: linear-gradient(to right, #1c3d72, #2a4d69);
    border-radius: 5px;
  }
  
  .col h4,
.col ul {
  text-transform: uppercase; /* Make text uppercase */
}
 

  .row { display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 25px; }
  .col {
    flex: 1; min-width: 250px; background: #fff;
    border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.07);
    padding: 15px 20px;
  }
  .col h4 { margin-bottom: 8px; font-size: 14px; text-transform: uppercase; color: #fff; background: #1c3d72; padding: 5px 10px; border-radius: 5px 5px 0 0; }
  .col ul { list-style: none; padding: 10px 0 0 0; margin: 0; }
  .col ul li { margin: 4px 0; font-size: 13px; }
  .col ul li strong { color: #1c3d72; }

  table {
    width: 100%; border-collapse: collapse; margin-bottom: 25px;
    background: #fff; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
  }
  th {
    background: #1c3d72; color: #fff; padding: 6px; font-size: 13px; text-align: center;
  }
  td {
    text-align: center; padding: 6px; border-bottom: 1px solid #eef2f7; font-size: 13px;
  }
  tr:nth-child(even) td { background: #f9fbff; }
  .grade-tick { color: #1c3d72; font-size: 16px; }

  .section-title {
    font-weight: 700; margin: 25px 0 10px 0; font-size: 16px;
    color: #1c3d72; text-transform: uppercase; letter-spacing: 0.5px;
    border-left: 5px solid #1c3d72; padding-left: 10px;
  }

  .signatures { display: flex; justify-content: space-between; margin-top: 40px; }
  .sign {
    border-top: 2px solid #1c3d72; width: 45%; text-align: center;
    padding-top: 8px; font-size: 13px; color: #1c3d72; font-weight: 600;
  }

  @media print {
    body { background: #fff; -webkit-print-color-adjust: exact; }
    @page { size: A4; margin: 1cm; }
  }
    
  #resultTable td:nth-child(2),
  #resultTable th:nth-child(2),
  #resultTableBody input[name="subject"],
  #resultTableBody select[name="subject"] {
    text-transform: uppercase !important;
  }

</style>
</head>
<body>
    <div class="header">
        <img src="assets/images/auth/Damotak Logo.png" alt="School Logo" class="school-logo">
        <h3>Damotak International School</h3>
        <p>ADDRESS 1: NEW OBA ROAD, ILE-IDANDE AREA, OKE-ONITEA</p>
        <p>ADDRESS 2: AYEKALE IYALODE ROAD, ILE-IDANDE AREA, OKE-ONITEA</p>
        <p>Email: DamotakInc@gmail.com | 08033880730</p>
        <p><strong>Academic Session:</strong> ${sessionYear}</p>
    </div>

    <div class="row">
        <div class="col">
            <h4>Student Details</h4>
            <ul>
               <li><strong>Name:</strong> ${studentName}</li>
<li><strong>Gender:</strong> ${studentGender}</li>
<li><strong>Class:</strong> ${studentClass}</li>
<li><strong>Term:</strong> ${term}</li>
<li><strong>Student ID:</strong> ${studentID}</li>
<li><strong>Date Issued:</strong> ${new Date().toLocaleDateString()}</li>
            </ul>
        </div>
    </div>

    <div class="section-title">Subjects and Scores</div>
    ${resultTable.outerHTML}

    <div class="row">
        <div class="col">
            <h4>Summary</h4>
            <ul>
                <li><strong>Total Marks:</strong> ${totalScoreValue}</li>
<li><strong>Average Score:</strong> ${avgScore}%</li>
            </ul>
        </div>
        <div class="col">
            <h4>Promotion Status</h4>
            <ul>
               <li><strong>Promotion Status:</strong> ${promotionStatus}</li>
            </ul>
        </div>
    </div>

    <div class="signatures">
        <div class="sign">Class Teacher‚Äôs Signature</div>
        <div class="sign">Headmaster‚Äôs Signature</div>
    </div>
</body>
</html>
    `);
    printWindow.document.close();

    printWindow.onload = () => {
        const fileTitle = `${studentName.replace(/\s+/g, "_")}_${studentID}_Result`;
        printWindow.document.title = fileTitle;
        setTimeout(() => {
            printWindow.focus();
            printWindow.print();
        }, 1000);

        printWindow.onafterprint = printWindow.onbeforeunload = () => {
            printWindow.close();
            location.href = "result-add.html";
        };
    };
});


// ---------------------------
// UPDATED: Load & Save Yearly Summary (session-aware)
// ---------------------------
async function loadYearlySummary(session = null, studentClassParam = null) {
  // session: optional string like "2024-2025"; if not given we try to auto-detect latest
  // studentClassParam: optional class string; if not given we'll read from DOM / DB

  const yearlyBody = document.getElementById("yearlySummaryBody");
  yearlyBody.innerHTML = "";

  // find session to operate on
  let usedSession = session;
  if (!usedSession) {
    // try to detect latest session stored in DB for this student
    try {
      const rootSnap = await get(ref(resultDb, `Results/${studentID}`));
      if (rootSnap.exists()) {
        const sessions = Object.keys(rootSnap.val());
        // If terms saved without sessions, sessions array may contain "First Term" etc.
        // if there's a session-like key like "2024-2025", pick latest numeric-like; otherwise fallback to null
        const sessionCandidates = sessions.filter(s => /^\d{4}[-/]\d{4}$/.test(s));
        usedSession = sessionCandidates.length ? sessionCandidates.sort().pop() : null;
      }
    } catch (err) {
      console.warn("Session auto-detect failed:", err);
      usedSession = null;
    }
  }

  // determine class: either param, or DOM, or DB
  let studentClass = studentClassParam || document.getElementById("studentClass")?.textContent || null;
  if (!studentClass && usedSession) {
    // try to read class from the session block
    const sessSnap = await get(ref(resultDb, `Results/${studentID}/${usedSession}`));
    if (sessSnap.exists()) {
      const classKeys = Object.keys(sessSnap.val() || {});
      studentClass = classKeys.length ? classKeys[0] : studentClass;
    }
  }

  // Terms inside a session/class
  const terms = ["First Term", "Second Term", "Third Term"];
  const termResults = {};
  let totalScore = 0;
  let subjectCount = 0;
  const allSubjectsSet = new Set();

  // Fetch results for each term (session-aware if session present else fallback to flat path)
  for (let t of terms) {
    let snapshot;
    if (usedSession && studentClass) {
      snapshot = await get(ref(resultDb, `Results/${studentID}/${usedSession}/${studentClass}/${t}`));
    } else {
      // fallback: path without session/class (older schema)
      snapshot = await get(ref(resultDb, `Results/${studentID}/${t}`));
    }
    termResults[t] = snapshot.exists() ? (snapshot.val().Subjects || snapshot.val().subjects || {}) : {};
    // collect subjects
    Object.keys(termResults[t] || {}).forEach(s => allSubjectsSet.add(s.trim().toLowerCase()));
  }

  const allSubjects = Array.from(allSubjectsSet);

  // Build rows and compute averages
  allSubjects.forEach((subjectKey, index) => {
    // find original keys in each term object (case-insensitive)
    const findKey = (obj) => {
      if (!obj) return "";
      return Object.keys(obj).find(k => k.trim().toLowerCase() === subjectKey) || "";
    };

    const firstKey = findKey(termResults["First Term"]);
    const secondKey = findKey(termResults["Second Term"]);
    const thirdKey = findKey(termResults["Third Term"]);

    const firstTotal = (termResults["First Term"][firstKey]?.total) || 0;
    const secondTotal = (termResults["Second Term"][secondKey]?.total) || 0;
    const thirdTotal = (termResults["Third Term"][thirdKey]?.total) || 0;

    const avgTotal = ((firstTotal + secondTotal + thirdTotal) / 3).toFixed(2);

    totalScore += parseFloat(avgTotal);
    subjectCount++;

    let grade, remark;
    if (avgTotal >= 70) { grade = "A"; remark = "Excellent"; }
    else if (avgTotal >= 60) { grade = "B"; remark = "Very Good"; }
    else if (avgTotal >= 50) { grade = "C"; remark = "Good"; }
    else if (avgTotal >= 40) { grade = "D"; remark = "Fair"; }
    else { grade = "F"; remark = "Fail"; }

    const displayName = firstKey || secondKey || thirdKey || subjectKey;

    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${index + 1}</td>
      <td>${displayName}</td>
      <td>${firstTotal}</td>
      <td>${secondTotal}</td>
      <td>${thirdTotal}</td>
      <td>${avgTotal}</td>
      <td>${grade}</td>
      <td>${remark}</td>
    `;
    yearlyBody.appendChild(row);
  });

  if (allSubjects.length === 0) {
    yearlyBody.innerHTML = `
      <tr>
        <td colspan="8" style="text-align:center;color:#d9534f;font-weight:bold;">
          ‚ÑπÔ∏è No previous result found.
        </td>
      </tr>`;
  }

  const overallAverage = subjectCount ? (totalScore / subjectCount).toFixed(2) : "0.00";

  let promotionStatus = "";
  if (overallAverage >= 80) promotionStatus = "Promoted to the Next Class with Distinction";
  else if (overallAverage >= 50) promotionStatus = "Promoted to the Next Class";
  else if (overallAverage >= 40) promotionStatus = "Promotion on Trial";
  else promotionStatus = "Fail";

  // Update UI fields
  document.getElementById("promotionStatus").value = promotionStatus;
  document.getElementById("yearlyFinalAverage").textContent = overallAverage;

  // SAVE YEARLY SUMMARY into DB at the correct path
  // prefer session/class path if available, otherwise fallback to flat path
  try {
    let targetPath;
    if (usedSession && studentClass) {
      targetPath = `Results/${studentID}/${usedSession}/${studentClass}/Yearly Summary`;
    } else {
      targetPath = `Results/${studentID}/Yearly Summary`;
    }

    const subjectsToSave = allSubjects.map(subKey => {
      // compute avg again for saving
      const first = termResults["First Term"][subKey]?.total || 0;
      const second = termResults["Second Term"][subKey]?.total || 0;
      const third = termResults["Third Term"][subKey]?.total || 0;
      return {
        subjectName: subKey,
        avgScore: (first + second + third) / 3
      };
    });

    await set(ref(resultDb, targetPath), {
      Subjects: subjectsToSave,
      totalScore: totalScore,
      average: overallAverage,
      promotionStatus
    });

    console.log("Yearly summary saved to", targetPath);
  } catch (err) {
    console.error("Failed saving yearly summary:", err);
    showNotification("‚ö†Ô∏è Failed saving yearly summary: " + err.message, false);
  }

  // return summary info for callers if needed
  return {
    session: usedSession,
    studentClass,
    average: overallAverage,
    promotionStatus
  };
}

// ---------------------------
// Helper: getNextClass
// ---------------------------
function getNextClass(currentClass) {
  const idx = CLASS_ORDER.indexOf(currentClass);
  if (idx === -1) return null;
  if (idx === CLASS_ORDER.length - 1) return "Graduated";
  return CLASS_ORDER[idx + 1];
}

// ---------------------------
// Helper: check whether session is complete
// returns true if First/Second/Third + Yearly Summary exist for given session/class
// ---------------------------
async function isSessionComplete(studentID, session, studentClass) {
  try {
    const basePath = `Results/${studentID}/${session}/${studentClass}`;
    const f = await get(ref(resultDb, `${basePath}/First Term`));
    const s = await get(ref(resultDb, `${basePath}/Second Term`));
    const t = await get(ref(resultDb, `${basePath}/Third Term`));
    const y = await get(ref(resultDb, `${basePath}/Yearly Summary`));
    return f.exists() && s.exists() && t.exists() && y.exists();
  } catch (err) {
    console.error("isSessionComplete error:", err);
    return false;
  }
}

// ---------------------------
// Promote student and create new session (session increments by 1 year)
// ---------------------------
async function promoteStudentAndCreateSession(studentID, fromSession, currentClass) {
  if (!AUTO_PROMOTE) {
    console.log("AUTO_PROMOTE is disabled. Skipping promotion.");
    return;
  }

  try {
    const nextClass = getNextClass(currentClass);
    if (!nextClass) {
      console.warn("Unknown current class:", currentClass);
      return;
    }

    // build new session string: "YYYY-YYYY" increment both
    let newSession = null;
    if (/^(\d{4})[-/](\d{4})$/.test(fromSession)) {
      const m = fromSession.match(/^(\d{4})[-/](\d{4})$/);
      const a = parseInt(m[1], 10);
      const b = parseInt(m[2], 10);
      newSession = `${a + 1}-${b + 1}`;
    } else {
      // fallback: if fromSession is missing or not well-formed, build from current year
      const now = new Date();
      const a = now.getFullYear();
      newSession = `${a}-${a + 1}`;
    }

    const studentRef = ref(resultDb, `Results/${studentID}`);

    if (nextClass === "Graduated") {
      // mark latest session/class as graduated flag (we won't create a new session)
      await set(ref(resultDb, `Results/${studentID}/${newSession}`), { Graduated: true });
      console.log(`Student ${studentID} graduated.`);
      // Optionally update Students/${studentID}/graduated = true
      await update(ref(studentDb, `Students/${studentID}`), { studentClass: "Graduated", graduated: true });
      return;
    }

    // Create the new session -> class -> empty terms structure
    const newData = {
      [newSession]: {
        [nextClass]: {
          "First Term": { Subjects: {} },
          "Second Term": { Subjects: {} },
          "Third Term": { Subjects: {} },
          "Yearly Summary": {}
        }
      }
    };

    // Write new session
    await set(studentRef, {
      ...( (await get(studentRef)).val() || {} ), // preserve existing sessions
      ...newData
    });

    // update Students entry to reflect new class
    await update(ref(studentDb, `Students/${studentID}`), { studentClass: nextClass });

    console.log(`Promoted ${studentID} from ${currentClass} (${fromSession}) to ${nextClass} in ${newSession}`);
    showNotification(`üéâ Student promoted to ${nextClass} (session ${newSession})`, true);
  } catch (err) {
    console.error("promoteStudentAndCreateSession error:", err);
    showNotification("‚ö†Ô∏è Promotion failed: " + err.message, false);
  }
}

  const res = await saveResult(studentID, term, resultData);
  showNotification(res.message, res.success);

  if (res.success) {
    // reload the current term's results so user sees saved data
    setTimeout(loadPreviousResults, 400);

    // If the saved term was the Yearly Summary, perform year-end processing
    if (term === "Yearly Summary") {
      try {
        // Try to auto-detect session/class from DB as used by loadYearlySummary
        const rootSnap = await get(ref(resultDb, `Results/${studentID}`));
        let latestSession = null;
        let currentClass = document.getElementById("studentClass")?.textContent || null;
        if (rootSnap.exists()) {
          const sessions = Object.keys(rootSnap.val()).filter(s => /^\d{4}[-/]\d{4}$/.test(s));
          if (sessions.length) {
            latestSession = sessions.sort().pop();
            // attempt to read class for that session
            const classSnap = await get(ref(resultDb, `Results/${studentID}/${latestSession}`));
            if (classSnap.exists()) {
              currentClass = Object.keys(classSnap.val())[0] || currentClass;
            }
          }
        }

        // Recompute and save Yearly Summary to correct path then try promotion
        const summaryInfo = await loadYearlySummary(latestSession, currentClass);

        // only promote if session data is actually complete
        const complete = await isSessionComplete(studentID, latestSession, currentClass);
        if (complete) {
          await promoteStudentAndCreateSession(studentID, latestSession, currentClass);
        } else {
          console.log("Year not complete; promotion skipped.");
        }
      } catch (err) {
        console.error("Year-end processing error:", err);
      }
    }
  }


// ---------------------------
// Auto-promotion toggle
// Comment out / uncomment to disable / enable automatic promotion
// ---------------------------
const AUTO_PROMOTE = true; // <-- set false to disable automatic promotion (or comment out)
const CLASS_ORDER = [
  "Creche",
  "Nursery 1",
  "Nursery 2",
  "Primary 1",
  "Primary 2",
  "Primary 3",
  "Primary 4",
  "Primary 5",
  "JSS 1",
  "JSS 2",
  "JSS 3",
  "SSS 1",
  "SSS 2",
  "SSS 3"
];


    // Get the current session and class
    const studentRef = firebase.database().ref('Results/' + studentID);
    studentRef.once('value').then(snapshot => {
        const sessions = Object.keys(snapshot.val() || {});
        if(sessions.length === 0) return; // No sessions found

        const latestSession = sessions.sort().pop(); // get latest session
        const latestClass = Object.keys(snapshot.val()[latestSession])[0];
        const termData = snapshot.val()[latestSession][latestClass];

        // Check if all terms + yearly summary exist
        if(termData['First Term'] && termData['Second Term'] && termData['Third Term'] && termData['Yearly Summary']) {
            
            // Determine next class
            const currentIndex = classOrder.indexOf(latestClass);
            let nextClass = currentIndex < classOrder.length - 1 ? classOrder[currentIndex + 1] : "Graduated";

            // Create new session
            const yearParts = latestSession.split('-');
            const newSession = (parseInt(yearParts[0]) + 1) + "-" + (parseInt(yearParts[1]) + 1);

            if(nextClass !== "Graduated") {
                const newData = {
                    [nextClass]: {
                        "First Term": {},
                        "Second Term": {},
                        "Third Term": {},
                        "Yearly Summary": {}
                    }
                };
                studentRef.child(newSession).set(newData)
                    .then(() => console.log(`${studentID} promoted to ${nextClass} in session ${newSession}`))
                    .catch(err => console.error(err));
            } else {
                // Mark as graduated
                studentRef.child(newSession).set({ Graduated: true })
                    .then(() => console.log(`${studentID} has graduated!`))
                    .catch(err => console.error(err));
            }
        } else {
            console.log(`Student ${studentID} has incomplete term data. Promotion not possible.`);
        }
    });



// ---------------------------
// Navigation Buttons
// ---------------------------
document.getElementById("backBtn").addEventListener("click", () => window.location.href = "result-list.html");

// ---------------------------
// Define tbody selector (matches your HTML)
// ---------------------------
const tbody = document.getElementById("resultTableBody");


// ---------------------------
// Define subjects by class for Nursery and Primary (customize as needed)
// ---------------------------
const subjectsByClass = {
  "Nursery 1": ["English", "Mathematics", "Basic Science", "Social Studies", "Creative Arts"],
  "Nursery 2": ["English", "Mathematics", "Basic Science", "Social Studies", "Creative Arts", "Physical Education"],
  "Nursery 3": ["English", "Mathematics", "Basic Science", "Social Studies", "Creative Arts", "Physical Education", "Computer Studies"],
  "Primary 1": ["English", "Mathematics", "Basic Science", "Social Studies", "Creative Arts", "Physical Education", "Computer Studies", "Civic Education"],
  "Primary 2": ["English", "Mathematics", "Basic Science", "Social Studies", "Creative Arts", "Physical Education", "Computer Studies", "Civic Education", "Home Economics"],
  "Primary 3": ["English", "Mathematics", "Basic Science", "Social Studies", "Creative Arts", "Physical Education", "Computer Studies", "Civic Education", "Home Economics", "Agricultural Science"],
  "Primary 4": ["English", "Mathematics", "Basic Science", "Social Studies", "Creative Arts", "Physical Education", "Computer Studies", "Civic Education", "Home Economics", "Agricultural Science", "French"],
  "Primary 5": ["English", "Mathematics", "Basic Science", "Social Studies", "Creative Arts", "Physical Education", "Computer Studies", "Civic Education", "Home Economics", "Agricultural Science", "French", "Music"],
  "Primary 6": ["English", "Mathematics", "Basic Science", "Social Studies", "Creative Arts", "Physical Education", "Computer Studies", "Civic Education", "Home Economics", "Agricultural Science", "French", "Music", "Business Studies"]
};

// ---------------------------
// Function to auto-populate subjects based on class (for Nursery/Primary only)
// ---------------------------
function populateSubjectsForClass(studentClass) {
  const normalizedClass = studentClass.replace(/\s+/g, ' ').trim(); // Normalize spaces
  const addRowBtn = document.getElementById("addRow");

  // Clear existing rows
  tbody.innerHTML = "";

  // Check if class is Nursery or Primary (and not SS3)
  if ((normalizedClass.startsWith("Nursery") || normalizedClass.startsWith("Primary")) && !isSS3 && subjectsByClass[normalizedClass]) {
    // Disable manual "Add Row" button (still visible, but not clickable)
    if (addRowBtn) addRowBtn.disabled = true;

    // Populate rows for each subject (read-only subjects, editable CA/Exam)
    subjectsByClass[normalizedClass].forEach(subject => {
      addSubjectRow(subject, "", "", "", "0", "-", "-", true); // readOnly=true for subject
    });

    console.log(`Auto-populated subjects for ${normalizedClass}`);
  } else {
    // Re-enable "Add Row" for non-matching classes (e.g., SS3 or undefined)
    if (addRowBtn) addRowBtn.disabled = false;
    // Optionally add a default empty row
    addSubjectRow();
  }
}




  

